<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¬å®¶å¸¥å²³-æ¬å®¶è¦åŠƒæ›¸ç³»çµ±</title>
   
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { bg: '#FDFBF5', yellow: '#FDB813', teal: '#4FD0C9', dark: '#2A2A2A', red: '#FF6B6B', primary: '#FDB813' }
          },
          fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
        }
      }
    }
  </script>

<style>
    /* 1. åŸºç¤è¨­å®š */
    body { background-color: #FDFBF5; color: #2A2A2A; -webkit-font-smoothing: antialiased; padding-bottom: 80px; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    
    /* 2. æ­¥é©Ÿå€å¡Šå‹•ç•« */
    .step-section { display: none; opacity: 0; scroll-margin-top: 100px; transition: opacity 0.5s ease-in-out; }
    .step-section.active { display: block; animation: slideUpFade 0.5s forwards; }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* 3. UI å…ƒä»¶ */
    .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03); margin-bottom: 16px; position: relative; }
    .input-field, .select-field, textarea { width: 100%; padding: 12px; background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 10px; font-size: 15px; outline: none; transition: all 0.2s; }
    .input-field:focus, .select-field:focus, textarea:focus { border-color: #FDB813; background-color: #FFF; ring: 2px solid #FDB813; }
    textarea { resize: vertical; min-height: 80px; }
    
    .btn-main { background: #2A2A2A; color: white; font-weight: 700; border-radius: 50px; padding: 16px; width: 100%; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; cursor: pointer; }
    .btn-main:active { transform: scale(0.98); }
    .btn-main:disabled { background: #ccc; cursor: not-allowed; }

    .option-card { border: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
    .option-card.selected { border-color: #FDB813; background-color: #FFFDF5; }
    .option-card.selected i { color: #FDB813; }

    .toggle-btn { padding: 8px; border-radius: 8px; border: 1px solid #E5E7EB; text-align: center; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
    .toggle-btn.active { background-color: #FDB813; color: white; border-color: #FDB813; font-weight: 700; }
    .floor-btn { background-color: #F3F4F6; border: 1px solid #E5E7EB; padding: 10px 0; text-align: center; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; user-select: none; }
    .floor-btn.selected { background-color: #2A2A2A; color: white; border-color: #2A2A2A; font-weight: 700; transform: scale(1.05); }

    /* ç…§ç‰‡ä¸Šå‚³ */
    .photo-scroll-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
    .add-photo-btn { flex-shrink: 0; width: 80px; height: 80px; border: 2px dashed #CBD5E1; border-radius: 12px; background: #F8FAFC; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #94A3B8; }
    .photo-thumbnail { flex-shrink: 0; width: 80px; height: 80px; border-radius: 12px; position: relative; overflow: hidden; border: 1px solid #E2E8F0; }
    .photo-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    .btn-delete-img { position: absolute; top: -6px; right: -6px; background: #64748B; color: white; border-radius: 50%; width: 22px; height: 22px; line-height: 20px; text-align: center; font-size: 14px; font-weight: bold; cursor: pointer; z-index: 10; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* å‹•æ…‹å¡ç‰‡ */
    .dynamic-card { border: 1px solid #FDB813; border-radius: 12px; margin-top: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.03); overflow: hidden; position: relative; transition: all 0.3s ease; }
    .card-header { position: relative; padding: 18px 50px 18px 45px; cursor: pointer; background: #FFF8E1; border-bottom: 1px solid #FDB813; }
    .card-body { padding: 20px; animation: slideDown 0.3s ease-out; }
    .card-body.collapsed { display: none; }
    .toggle-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%) rotate(0deg); transition: transform 0.3s; font-size: 16px; color: #5A6573; }
    .dynamic-card.active .toggle-icon { transform: translateY(-50%) rotate(90deg); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .card-actions { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); display: flex; gap: 8px; }
    .btn-card-action { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9CA3AF; background: rgba(255,255,255,0.8); border: 1px solid transparent; cursor: pointer; }
    .btn-card-action:hover { background: #FFF; border-color: #E5E7EB; color: #4B5563; }
    .btn-card-action.delete:hover { color: #EF4444; background: #FEF2F2; border-color: #FECACA; }

    /* ç‰©å“å¡ç‰‡ */
    .item-card { border: 1px solid #E5E7EB; background: #fff; border-radius: 12px; margin-top: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.02); transition: all 0.2s; }
    .item-header { padding: 14px 16px; background: #F9FAFB; cursor: pointer; position: relative; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid transparent; }
    .item-card.active .item-header { background: #F9FAFB; border-bottom: 1px solid #E5E7EB; }
    .item-body { padding: 20px; background: #FFFFFF; display: none; }
    .item-body.active { display: block; animation: slideDown 0.2s ease-out; }
    .item-title-block { margin-bottom: 6px; }
    .item-name { font-size: 15px; font-weight: 700; color: #1F2937; margin-right: 4px; }
    .item-qty { font-size: 16px; font-weight: 800; color: #1F2937; } 
    .item-tags-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .tag-std { background-color: #FFFFFF; border: 1px solid #E5E7EB; color: #6B7280; font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 4px; }
    .tag-highlight { background-color: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }
    .item-risk-bar { padding: 10px 14px; font-size: 12px; line-height: 1.5; font-weight: 700; display: flex; align-items: center; border-top: 1px solid rgba(0,0,0,0.05); }
    .risk-bg-red { background-color: #FEF2F2; color: #B91C1C; border-left: 4px solid #EF4444; } 
    .risk-bg-orange { background-color: #FFF7ED; color: #C2410C; border-left: 4px solid #F97316; } 
    .risk-bg-green { background-color: #F0FDF4; color: #15803D; border-left: 4px solid #22C55E; } 
    .item-arrow-icon { font-size: 14px; color: #9CA3AF; transition: transform 0.3s; margin-right: 10px; margin-top: 4px; }
    .item-card.active .item-arrow-icon { transform: rotate(90deg); color: #FDB813; }
    .item-actions { display: flex; gap: 6px; }
    .btn-icon-sm { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9CA3AF; background: #FFF; border: 1px solid #E5E7EB; cursor: pointer; }
    .btn-icon-sm:hover { background: #F3F4F6; color: #4B5563; }
    .btn-icon-sm.delete:hover { background: #FEE2E2; color: #EF4444; border-color: #FECACA; }

    /* æŒ‰éˆ• Loading */
    .btn-loading { pointer-events: none; opacity: 0.8; cursor: wait; }
    .btn-loading i { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* çµæœèˆ‡æ˜ç´° */
    .result-total-card { text-align: center; border: 2px solid #FDB813; background: #FFFDF5; padding: 20px; border-radius: 16px; margin-bottom: 20px; }
    .result-amount { font-size: 48px; font-weight: 800; color: #2A2A2A; margin: 10px 0; }
    .result-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding-top: 15px; border-top: 1px solid #E5E7EB; }
    .result-summary-item label { font-size: 12px; color: #9CA3AF; display: block; margin-bottom: 2px; }
    .result-summary-item span { font-size: 16px; font-weight: 700; color: #2A2A2A; }
    .breakdown-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F3F4F6; font-size: 15px; }
    .breakdown-row:last-child { border-bottom: none; }
    .breakdown-label { font-weight: 700; color: #374151; }
    .breakdown-desc { font-size: 12px; color: #9CA3AF; flex: 1; text-align: right; margin: 0 10px; }
    .breakdown-val { font-weight: 800; color: #1F2937; }
    
    /* æé†’èˆ‡æ¢æ¬¾ */
    .reminder-list { list-style: none; padding: 0; margin: 0; }
    .reminder-item { position: relative; padding-left: 26px; margin-bottom: 10px; font-size: 14px; line-height: 1.6; color: #4B5563; }
    .terms-box { background: #FFFDF5; border: 1px solid #FDB813; padding: 20px; border-radius: 12px; font-size: 13px; line-height: 1.8; color: #4B5563; max-height: 1200px; overflow-y: auto; text-align: justify; }
    .terms-box h4 { color: #2A2A2A; font-weight: 700; margin-bottom: 10px; font-size: 15px; }
    .terms-box ol { list-style-type: decimal; padding-left: 20px; margin-bottom: 15px; }
    .terms-box li { margin-bottom: 8px; }
    .terms-highlight { background: #FCE7A2; padding: 0 4px; border-radius: 2px; font-weight: bold; color: #000; }
    
    /* ç°½åå€ */
    .signature-area { background: white; border: 2px dashed #CBD5E1; border-radius: 12px; position: relative; height: 180px; width: 100%; margin-top: 10px; touch-action: none; }
    .signature-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #CBD5E1; pointer-events: none; font-size: 20px; font-weight: bold; }
    #signature-canvas { width: 100%; height: 100%; cursor: crosshair; }

    /* åˆ—å°æ¨£å¼ */
    @media print {
        button, header, footer, #step-6-footer, .add-photo-btn, .btn-delete-img, .fixed, #progress-bar, .no-print { display: none !important; }
        body, .container, .main-content { width: 100% !important; margin: 0 !important; padding: 0 !important; background: white !important; color: black !important; overflow: visible !important; }
        .step-section, .card-body, .item-body { display: block !important; opacity: 1 !important; height: auto !important; visibility: visible !important; overflow: visible !important; max-height: none !important; }
        .card-collapsed-info { display: none !important; }
        .terms-box, #guide-content { max-height: none !important; overflow: visible !important; border: none !important; }
        input, textarea, select { border: none !important; background: transparent !important; resize: none !important; padding: 0 !important; font-weight: bold !important; color: #000 !important; -webkit-appearance: none; appearance: none; }
        select::-ms-expand { display: none; }
        .card, .step-section, h3, h4 { break-inside: avoid; page-break-inside: avoid; }
    }
</style>
</head>

<body class="min-h-screen flex flex-col pb-28">

  <div class="fixed top-0 left-0 right-0 h-1 bg-gray-100 z-50">
    <div id="progress-bar" class="h-full bg-brand-yellow transition-all duration-500" style="width: 16%"></div>
  </div>

  <header class="p-4 pt-6 bg-white/90 backdrop-blur sticky top-0 z-40 border-b border-gray-100 flex justify-between items-center">
    <div><h1 class="text-xl font-bold" id="page-title">ã€å¸¥å²³é™ªä½ ï¼Œè£½ä½œå°ˆå±¬æ¬å®¶è¦åŠƒæ›¸ã€‘</h1><p class="text-gray-500 text-xs" id="page-desc">æ­¤æœå‹™éœ€è¼¸å…¥æœƒå“¡ä»£ç¢¼æ–¹å¯ä½¿ç”¨</p></div>
    <div class="w-9 h-9 bg-brand-yellow rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md">å²³</div>
  </header>

  <main class="flex-1 max-w-md mx-auto w-full p-4">
      
    <div id="steps-container">
    <div id="step-0" class="step-section active">
          <div id="step0-form" class="space-y-5 mt-4">
            <div><label class="block text-sm font-bold text-gray-700 mb-2">1. è«‹å•æ€éº¼ç¨±å‘¼æ‚¨ï¼Ÿ</label><input type="text" id="input-name" class="input-field" placeholder="ä¾‹å¦‚ï¼šé™³å…ˆç”Ÿ"></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-2">2. Email </label><input type="email" id="input-email" class="input-field" placeholder="name@example.com"></div>
            
            <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-200">
               <label class="block text-sm font-bold text-gray-700 mb-2">3. æ¨è–¦äºº/æœƒå“¡ä»£ç¢¼ (å¿…å¡«)</label>
               <p class="text-xs text-gray-500 mb-2">è«‹è¼¸å…¥æ‚¨æˆ–æ¨è–¦äººçš„å°ˆå±¬æœƒå“¡ä»£ç¢¼ä»¥å•Ÿç”¨æœå‹™ã€‚</p>
               <div class="flex gap-2">
                  <input type="text" id="input-referrer" class="input-field" placeholder="è«‹è¼¸å…¥æœƒå“¡ä»£ç¢¼">
               </div>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-3">4. é€™æ¬¡éœ€è¦æ¬ä»€éº¼ï¼Ÿ</label>
              <div class="grid grid-cols-3 gap-2">
                <div class="option-card bg-white p-3 rounded-xl text-center" onclick="selectType('furniture', this)"><div class="text-2xl text-gray-300 mb-1"><i class="fas fa-couch"></i></div><div class="text-xs font-bold">å‚¢ä¿±æ¬é‹</div></div>
                <div class="option-card bg-white p-3 rounded-xl text-center" onclick="selectType('home', this)"><div class="text-2xl text-gray-300 mb-1"><i class="fas fa-home"></i></div><div class="text-xs font-bold">ä½å®¶æ¬å®¶</div></div>
                <div class="option-card bg-white p-3 rounded-xl text-center" onclick="selectType('office', this)"><div class="text-2xl text-gray-300 mb-1"><i class="fas fa-building"></i></div><div class="text-xs font-bold">è¾¦å…¬æ¬å®¶</div></div>
              </div>
              <input type="hidden" id="input-type">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">5. é è¨ˆå“ªä¸€å¤©æ¬ï¼Ÿ</label>
              <input type="date" id="input-date" class="input-field" onchange="checkDate()">
              <div id="date-alert" class="hidden mt-3 p-3 rounded-xl text-sm border bg-gray-50 text-gray-600"></div>
            </div>
          </div>
        </div>

        <div id="step-1" class="step-section">
          <div id="out-list">
            <div class="flex justify-between items-center mb-3 mt-2"><span class="text-sm font-bold text-gray-500">æ¬å‡ºåœ°é» (FROM)</span><button onclick="addLocation('out')" class="text-brand-teal text-xs font-bold border border-brand-teal px-2 py-1 rounded hover:bg-brand-teal hover:text-white transition">+ æ–°å¢åœ°é»</button></div>
          </div>
          <div class="my-8 border-t border-dashed border-gray-300"></div>
          <div id="in-list">
            <div class="flex justify-between items-center mb-3"><span class="text-sm font-bold text-gray-500">æ¬å…¥åœ°é» (TO)</span><button onclick="addLocation('in')" class="text-brand-yellow text-xs font-bold border border-brand-yellow px-2 py-1 rounded hover:bg-brand-yellow hover:text-white transition">+ æ–°å¢åœ°é»</button></div>
          </div>
        </div>

        <div id="step-2" class="step-section">
          <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-4 flex gap-3">
            <div class="text-blue-500 text-xl"><i class="fas fa-box-open"></i></div>
            <div class="text-xs text-blue-800 leading-relaxed"><strong>æ•´ç†å¸«é˜¿å²³ï¼š</strong><br>è«‹æ–°å¢ä¸¦æ‹æ”æ‚¨éœ€è¦æ‰“åŒ…çš„å€åŸŸï¼ˆå¦‚ï¼šä¸»è‡¥è¡£æ«ƒã€æ›¸æ¶ï¼‰ã€‚<br>AI æœƒå¹«æ‚¨ä¼°ç®—ç´™ç®±æ•¸ä¸¦æä¾›æ‰“åŒ…å»ºè­°ã€‚</div>
          </div>
          <div id="packing-area-list"></div>
          <button onclick="addPackingArea()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:border-brand-teal hover:text-brand-teal transition mb-6 flex items-center justify-center"><i class="fas fa-plus mr-2"></i> æ–°å¢æ‰“åŒ…å€åŸŸ</button>
          <div class="card bg-white border border-gray-200 shadow-sm">
            <h4 class="font-bold text-brand-dark mb-4 text-sm flex items-center gap-2"><i class="fas fa-cart-plus text-brand-yellow"></i> åŠ å€¼æœå‹™é¸æ“‡</h4>
            <div class="space-y-4 mb-6">
              <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                <div><div class="font-bold text-sm text-gray-700">æ¬å®¶å‰ä»£å®¢æ‰“åŒ…</div><div class="text-[11px] text-gray-400 mt-0.5">$500 / ç®± (å«å·¥è³‡+è† å¸¶)</div></div>
                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="service-pack" class="sr-only peer" onchange="calcStep2Total()"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-teal"></div></label>
              </div>
              <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                <div><div class="font-bold text-sm text-gray-700">æ¬å®¶å¾Œä¸Šæ¶æ­¸ä½</div><div class="text-[11px] text-gray-400 mt-0.5">$600 / ç®± (å«æ”¶ç´+æ­¸ä½)</div></div>
                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="service-unpack" class="sr-only peer" onchange="calcStep2Total()"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-yellow"></div></label>
              </div>
            </div>
            <h4 class="font-bold text-brand-dark mb-3 text-sm flex items-center gap-2"><i class="fas fa-box text-brand-yellow"></i> éœ€æ·»è³¼åŒ…æ</h4>
            <div class="space-y-3">
              <div class="flex items-center justify-between"><div><label class="text-sm font-bold text-gray-600">æ¬å®¶ç”¨ç´™ç®±</label><div class="text-[10px] text-gray-400">54x40x36cm | $50/å€‹</div></div><div class="flex items-center gap-2"><input type="number" id="material-box" class="w-16 border rounded-lg p-2 text-center text-sm focus:border-brand-yellow outline-none" placeholder="0" min="0" onchange="calcStep2Total()"><span class="text-xs text-gray-500">å€‹</span></div></div>
              <div class="flex items-center justify-between"><div><label class="text-sm font-bold text-gray-600">æ°£æ³¡å¸ƒ</label><div class="text-[10px] text-gray-400">è¦æ ¼ï¼š30cm x 50m | $500/æ²</div></div><div class="flex items-center gap-2"><input type="number" id="material-bubble" class="w-16 border rounded-lg p-2 text-center text-sm focus:border-brand-yellow outline-none" placeholder="0" min="0" onchange="calcStep2Total()"><span class="text-xs text-gray-500">æ²</span></div></div>
            </div>
          </div>
          <div class="text-right mt-4 pr-2"><span class="text-xs text-gray-400">æ­¤æ­¥é©Ÿé ä¼°è²»ç”¨</span><div class="text-3xl font-extrabold text-brand-dark mt-1" id="step2-total">$ 0</div></div>
        </div>

        <div id="step-3" class="step-section">
           <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-4 mb-4 flex gap-3">
             <div class="text-brand-yellow text-xl"><i class="fas fa-couch"></i></div>
             <div class="text-xs text-yellow-800 leading-relaxed"><strong>æ¬å®¶é˜¿å²³ï¼š</strong><br>è«‹æ–°å¢å€åŸŸï¼ˆå¦‚ï¼šå®¢å»³ã€ä¸»è‡¥ï¼‰ï¼Œä¸¦æ‹æ”è©²å€æ‰€æœ‰å‚¢ä¿±ã€‚<br>AI æœƒè‡ªå‹•åˆ—å‡ºæ¸…å–®ä¸¦åˆ†ææ‹†è£éœ€æ±‚èˆ‡é¢¨éšªã€‚</div>
           </div>
           <div id="area-list-container"></div>
           <button onclick="addAreaCard()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:border-brand-primary hover:text-brand-primary transition mb-3 flex items-center justify-center"><i class="fas fa-plus mr-2"></i> æ–°å¢ä¸€å€‹å€åŸŸ (ä¾‹å¦‚: è‡¥å®¤)</button>
           <button id="undo-area-btn" onclick="undoDeleteArea()" class="text-xs text-gray-400 text-center w-full hover:text-gray-600" disabled><i class="fas fa-undo"></i> é‚„åŸå‰›åˆªé™¤çš„å€åŸŸ</button>
        </div>

        <div id="step-4" class="step-section">
           <div class="card bg-white">
              <h4 class="font-bold text-brand-dark mb-2 text-base">ç‰¹æ®Šå‚™è¨»</h4>
              <p class="text-xs text-gray-400 mb-4">ä»»ä½•éœ€è¦æˆ‘å€‘é¡å¤–æ³¨æ„çš„äº‹é … (ä¾‹å¦‚ï¼šæ˜“ç¢å“ç‰¹åˆ¥å¤šã€éœ€è¦å€Ÿç”¨ç´™ç®±...)</p>
              <textarea id="final-special-notes" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:border-brand-yellow outline-none" rows="5" placeholder="è«‹å¡«å¯«å‚™è¨»..."></textarea>
           </div>
           <div class="text-center mt-6 mb-4">
             <p class="text-gray-500 text-sm mb-2">æº–å‚™å¥½ç”¢ç”Ÿä¼°åƒ¹å–®äº†å—ï¼Ÿ</p>
             <div class="text-xs text-gray-400">é»æ“Šã€Œç”¢ç”Ÿä¼°åƒ¹å–®ã€å¾Œï¼Œç³»çµ±å°‡è¨ˆç®—è²»ç”¨ä¸¦ç”¢ç”Ÿæ–‡ä»¶</div>
           </div>
        </div>

        <div id="step-5" class="step-section">
            <div class="card result-total-card">
                <h3 class="text-center text-sm font-medium text-gray-500 mb-0 border-none p-0">æ‚¨çš„é ä¼°ç¸½é‡‘é¡</h3>
                <div id="result-total-fee" class="result-amount">$ 0</div>
                <div class="result-summary-grid">
                    <div class="result-summary-item"> <label>é ä¼°è»Šæ¬¡</label> <span id="result-trucks">-</span> </div>
                    <div class="result-summary-item"> <label>é ä¼°äººåŠ›</label> <span id="result-manpower">-</span> </div>
                    <div class="result-summary-item"> <label>é ä¼°å·¥æ™‚</label> <span id="result-hours">-</span> </div>
                </div>
            </div>
            <div class="card">
                <h3 class="font-bold text-lg mb-2 text-brand-dark border-l-4 border-brand-yellow pl-3">è²»ç”¨æ˜ç´°</h3>
                <p class="text-xs text-gray-400 mb-4">é€æ˜çš„åƒ¹æ ¼ï¼Œè®“æ‚¨æœ€å®‰å¿ƒã€‚</p>
                <div class="space-y-0">
                    <div class="breakdown-row"> <span class="breakdown-label">åŸºæœ¬å‡ºå‹¤</span> <span id="desc-base-fee" class="breakdown-desc"></span> <span id="cost-base-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">æ¬æ¨“æ¢¯è²»</span> <span id="desc-stair-fee" class="breakdown-desc"></span> <span id="cost-stair-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">ç‰¹æ®Šå‹•ç·š</span> <span id="desc-special-route-fee" class="breakdown-desc"></span> <span id="cost-special-route-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">æ‹†è£è²»ç”¨</span> <span id="desc-disassembly-fee" class="breakdown-desc"></span> <span id="cost-disassembly-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">è·¨ç¸£å¸‚è²»</span> <span id="desc-inter-city-fee" class="breakdown-desc"></span> <span id="cost-inter-city-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">åŠè»Šè²»ç”¨</span> <span id="desc-crane-fee" class="breakdown-desc"></span> <span id="cost-crane-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">åŒ…æè²»ç”¨</span> <span id="desc-packing-fee" class="breakdown-desc"></span> <span id="cost-packing-fee" class="breakdown-val">$ 0</span> </div>
                    <div class="breakdown-row"> <span class="breakdown-label">æ•´ç†è²»ç”¨</span> <span id="desc-organizing-fee" class="breakdown-desc"></span> <span id="cost-organizing-fee" class="breakdown-val">$ 0</span> </div>
                </div>
            </div>
            <div class="card" style="border-left: 5px solid #FDB813;">
                <h3 class="font-bold text-lg mb-2 text-brand-dark">ğŸ”” æ¬å®¶å¤§å²³çš„è²¼å¿ƒæé†’</h3>
                <div id="reminder-content"></div>
            </div>
            <div class="card">
                <h3 class="font-bold text-lg mb-2 text-brand-dark border-l-4 border-brand-yellow pl-3">å‚™è¨»</h3>
                <p id="result-view-notes" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg"></p>
            </div>
        </div>

        <div id="step-6" class="step-section pb-20">
            <div class="text-center py-6 px-4 bg-white border-b border-gray-100 sticky top-0 z-30 shadow-sm">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-brand-yellow/10 text-brand-yellow mb-2"><i class="fas fa-clipboard-check text-xl"></i></div>
                <h2 class="text-xl font-bold text-brand-dark">æŠŠå®¶æ¬å¥½å¥½é»ƒé‡‘æŒ‡å—</h2>
                <p class="text-xs text-gray-500">é˜¿å²³ç‚ºæ‚¨é‡èº«æ‰“é€ çš„è¡Œå‹•æ¸…å–®</p>
            </div>
            <div id="guide-loading" class="hidden flex flex-col items-center justify-center py-20">
                <div class="relative w-20 h-20">
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-gray-100 rounded-full"></div>
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-brand-yellow rounded-full animate-spin border-t-transparent"></div>
                    <i class="fas fa-magic absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-brand-teal text-xl"></i>
                </div>
                <div class="mt-4 text-sm font-bold text-gray-600">æ­£åœ¨å®¢åˆ¶åŒ–æ’°å¯«æ¬å®¶æŒ‡å—...</div>
                <div class="text-xs text-gray-400 mt-1">åˆ†æè³‡æ–™ä¸­</div>
            </div>
            <div id="guide-content" class="max-w-2xl mx-auto px-4 py-6 space-y-8"></div>
            <div class="max-w-2xl mx-auto px-4 pb-6">
                <div class="terms-box mb-6">
                    <h4 class="text-center border-b pb-2 mb-3 border-yellow-200">æ¬é‹å¥‘ç´„æ›¸ç´„å®šäº‹é …</h4>
                    <ol>
                        <li>æœ¬ä¼°åƒ¹å–®ç¶“é›™æ–¹ç°½ç« å¾Œï¼Œå³è¦–ç‚ºé‹é€å¥‘ç´„æˆç«‹ï¼Œè«‹å‹™å¿…ç°½ç´„å‰ï¼Œè©³ç´°ç¢ºèªæ¬é‹ç‰©ä»¶å’Œæ•´ç†ç‰©ä»¶æ˜¯å¦æœ‰å®Œå–„ï¼Œæˆ‘å€‘å°‡ä¾ç…§æ¸…å–®é€²è¡Œæ¬é‹å’Œæ•´ç†æœå‹™ï¼</li>
                        <li>é›™æ–¹ç´„å®šä»¥æœ¬å…¬å¸ 35 å¹´ä¼°åƒ¹ç¶“é©—ç™¼å±•å‡ºçš„<span class="terms-highlight">ã€ŒåŒ…åƒ¹ã€è¨ˆè²»æ–¹æ¡ˆ</span>ã€‚ç¶“ç°½ç´„å¾Œï¼Œä»»ä½•ä¸€æ–¹ä¸å¾—è—‰æ•…åŠ åƒ¹æˆ–è¦æ±‚æœªç´„å®šä¹‹é™„åŠ è²»ç”¨ã€‚</li>
                        <li>è‹¥ç°½ç´„å®Œæˆå¾Œæœ‰æ¬é‹ç‰©ä»¶ä¹‹å¢æ¸›ï¼Œç¶“å®¢æœç¢ºèªå¾Œï¼Œå°‡èª¿æ•´ä¼°åƒ¹å–®å…§å®¹ï¼›äº¦å¯ç”±å¹³å°è©•ä¼°ç¢ºèªå¾Œé€²è¡Œè²»ç”¨å¢æ¸›ã€‚è‹¥å°šæœªæ¬é‹ï¼Œå¯é‡æ–°è¼¸å‡ºä¼°åƒ¹å–®ç°½ç«‹å¥‘ç´„ã€‚æ¬é‹ç•¶æ—¥è‹¥æœ‰ç‰©ä»¶å¢æ¸›ï¼Œå°‡ä¾ç•¶ä¸‹åˆ¤åˆ¥ä¸¦ç¶“å®¢æœç¢ºèªå¾Œèª¿æ•´è²»ç”¨ã€‚</li>
                        <li>ç°½ç´„å®Œæˆå¾Œï¼Œæœ¬å…¬å¸å°‡æ”¶å– <span class="terms-highlight">ç¸½åƒ¹ 50% ä½œç‚ºè¨‚é‡‘</span>ï¼›è‹¥æ–¼æ¬å®¶æ—¥å‰å–æ¶ˆæœå‹™ï¼Œè¨‚é‡‘ä¸äºˆé€€é‚„ã€‚</li>
                        <li>ç°½è¨‚å¥‘ç´„å¾Œï¼Œè‹¥æœ¬å…¬å¸é•ç´„ï¼Œæ‡‰è³ å„Ÿæ¶ˆè²»è€…å…¨éƒ¨é‹è²»ï¼›æ¶ˆè²»è€…é•ç´„ï¼Œæ‡‰è³ å„Ÿæœ¬å…¬å¸å…¨éƒ¨é‹è²»ä¹‹ 50% (èª¤æ™‚ã€ä¸‹é›¨æˆ–é›™æ–¹åŒæ„å»¶æœŸä¸åœ¨ä¸Šé™)ã€‚</li>
                        <li><span class="terms-highlight">å”®å¾Œç†è³ </span>ï¼šè‹¥æ¬å®¶å®Œå¾Œç¢ºèªç‰©ä»¶æå£ï¼Œä¸”æ–¼ã€Œ3æ—¥å…§ã€ç¶“èˆ‰è­‰ç¢ºèªç‚ºæˆ‘æ–¹é€ æˆï¼Œè³ å„Ÿä»¥æŠ˜èˆŠå¾Œç¾å€¼ä¹‹ 50% ç‚ºä¸Šé™ã€‚ç‰¹åˆ¥è²´é‡ç‰©å“ (å¦‚å¤è‘£ã€è—è¡“å“) å–®ä»¶åƒ¹å€¼è¶…éæ–°è‡ºå¹£ 10,000 å…ƒè€…ï¼Œæ‡‰äº‹å…ˆè²æ˜ï¼Œæœ¬å…¬å¸å¾—è¦–ä¿é¡é…Œæ”¶ä¿éšªè²»ã€‚</li>
                        <li>æ¬é‹ç•¶æ—¥è«‹èˆ‡å¸«å‚…å…±åŒå·¡æª¢ä¸¦å³æ™‚æºé€šï¼›ç¢ºèªç„¡èª¤å¾Œä¾ç´„å®Œæˆæ¬¾é …ç¹³ä»˜ã€‚é›¢å ´å¾Œè‹¥éœ€å†æ¬¡åˆ°å ´æœå‹™ï¼Œè²»ç”¨å¦è¨ˆã€‚</li>
                        <li>æœªç´„å®šäº‹é …æ‚‰ä¾èª ä¿¡åŸå‰‡åŠæ°‘æ³•ç›¸é—œè¦å®šï¼›å¦‚æœ‰çˆ­è­°ï¼Œé›™æ–¹ä»¥ <span class="terms-highlight">è‡ºç£è‡ºä¸­åœ°æ–¹æ³•é™¢</span> ç‚ºç¬¬ä¸€å¯©ç®¡è½„æ³•é™¢ã€‚</li>
                    </ol>
                    <div class="bg-gray-100 p-3 rounded-lg text-xs">
                        <div class="font-bold text-gray-700 mb-1">Deposit Information</div>
                        <div class="text-gray-600">å°åŒ—å¯Œé‚¦éŠ€è¡Œ åŒ—å°ä¸­åˆ†è¡Œ (012-7222)</div>
                        <div class="text-xl font-bold text-brand-dark my-1">8211-0000-428816</div>
                        <div class="text-gray-400 text-[10px]">è«‹ç¢ºèªå¸³è™Ÿç„¡èª¤å¾Œå†è¡ŒåŒ¯æ¬¾</div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold text-lg mb-2 text-brand-dark">âœï¸ å®¢æˆ¶ç°½å</h3>
                    <p class="text-xs text-gray-400 mb-2">è«‹åœ¨æ­¤å€åŸŸç°½åä»¥ç¢ºèªå¥‘ç´„å…§å®¹</p>
                    <div class="signature-area">
                        <span class="signature-placeholder">è«‹åœ¨æ­¤ç°½å</span>
                        <canvas id="signature-canvas"></canvas>
                        <button class="absolute bottom-2 right-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300" onclick="clearSignature()">é‡ç°½</button>
                    </div>
                </div>
            </div>
            
            <div id="step-6-footer" class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-50 flex flex-col gap-3 max-w-md mx-auto no-print">
                <div id="action-buttons" class="flex gap-3">
                    <button onclick="prevStep()" class="w-1/3 py-3 bg-white border border-gray-300 text-gray-600 rounded-xl font-bold hover:bg-gray-50 text-sm shadow-sm"><i class="fas fa-edit"></i> ä¸Šä¸€æ­¥ä¿®æ”¹</button>
                    <button id="btn-book-now" onclick="handleBooking()" class="flex-1 py-3 bg-brand-dark text-white rounded-xl font-bold hover:bg-gray-800 text-sm shadow-lg flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> ç¢ºèªé ç´„ä¸¦ç™¼é€è³‡æ–™</button>
                </div>
                <a id="btn-line-connect" href="https://line.me/R/ti/p/@movingbetter" target="_blank" class="hidden w-full py-4 bg-[#06C755] text-white rounded-xl font-bold hover:bg-[#05b64d] text-base shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 animate-pulse"><i class="fab fa-line text-2xl"></i> è³‡æ–™å·²å‚³é€ï¼é»æ­¤å‰å¾€ LINE å®˜æ–¹å¸³è™Ÿ</a>
            </div>
        </div>
    </div>
  </main>

  <footer id="main-footer" class="fixed bottom-0 left-0 right-0 p-5 bg-white/95 backdrop-blur border-t border-gray-100 z-50 shadow-lg">
    <div class="max-w-md mx-auto flex gap-3">
      <button id="btn-prev" onclick="prevStep()" class="hidden px-5 py-3 rounded-full border border-gray-300 text-gray-500 font-bold text-sm w-1/3 hover:bg-gray-50 transition"><i class="fas fa-arrow-left mr-1"></i> ä¸Šä¸€æ­¥</button>
      <button id="btn-next" onclick="nextStep()" class="btn-main px-6 flex-1 hover:scale-[1.02] transition-transform">
        <span class="opacity-80 text-xs font-normal" id="btn-text-sub">ä¸‹ä¸€æ­¥ï¼šåœ°é»èˆ‡å‹•ç·š</span>
        <span class="flex items-center text-lg"><span id="btn-text-main">GO</span> <i class="fas fa-arrow-right ml-2"></i></span>
      </button>
    </div>
  </footer>

  <template id="tpl-location-card">
    <div class="card location-card relative" data-type="" data-id="">
      <button class="absolute top-3 right-3 text-gray-300 hover:text-red-500 p-2" onclick="removeLocation(this)"><i class="fas fa-times"></i></button>
      <div class="mb-4"><span class="badge-type text-xs font-bold px-3 py-1 rounded-full text-white bg-gray-400 shadow-sm">åœ°é» 1</span></div>
      <div class="space-y-3 mb-5">
        <div class="grid grid-cols-3 gap-2">
          <select class="select-field city-select col-span-1" onchange="updateCardTitle(this)"><option value="">ç¸£å¸‚</option></select>
          <select class="select-field dist-select col-span-2"><option value="">å€åŸŸ</option></select>
        </div>
        <input type="text" class="input-field addr-input" placeholder="è¡—é“å··å¼„ / é–€ç‰Œè™Ÿç¢¼">
      </div>
      <div class="mb-5 bg-gray-50 p-3 rounded-xl border border-gray-100">
        <label class="block text-xs font-bold text-gray-500 mb-2">æ¨“å±¤ç‹€æ³</label>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div class="toggle-btn active btn-elev-yes" onclick="setElevator(this, true)">æœ‰é›»æ¢¯</div>
          <div class="toggle-btn btn-elev-no" onclick="setElevator(this, false)">ç„¡é›»æ¢¯</div>
        </div>
        <div class="floor-input-group floor-yes"><input type="number" class="input-field floor-input-val" placeholder="è«‹å•åœ¨å¹¾æ¨“ï¼Ÿ" min="2"></div>
        <div class="floor-input-group floor-no hidden">
           <div class="grid grid-cols-5 gap-2 floor-btn-container">
             <div class="floor-btn" onclick="toggleFloor(this, 'B2')">B2</div><div class="floor-btn" onclick="toggleFloor(this, 'B1')">B1</div>
             <div class="floor-btn" onclick="toggleFloor(this, '1F')">1F</div><div class="floor-btn" onclick="toggleFloor(this, '2F')">2F</div>
             <div class="floor-btn" onclick="toggleFloor(this, '3F')">3F</div><div class="floor-btn" onclick="toggleFloor(this, '4F')">4F</div>
             <div class="floor-btn" onclick="toggleFloor(this, '5F')">5F</div><div class="floor-btn" onclick="toggleFloor(this, '6F')">6F</div>
             <div class="floor-btn" onclick="toggleFloor(this, '7F')">7F</div><div class="floor-btn" onclick="toggleFloor(this, 'other')">å…¶ä»–</div>
           </div>
           <input type="hidden" class="floor-btn-val">
        </div>
      </div>
      <div class="border-t-2 border-dashed border-gray-200 pt-5 mt-5 space-y-6">
        <div class="flex justify-between items-center"><h4 class="text-sm font-bold text-gray-700 flex items-center"><i class="fas fa-camera-retro mr-2 text-brand-yellow"></i> å‹•ç·šç´€éŒ„</h4><span class="ai-status text-brand-teal text-xs font-bold hidden flex items-center bg-teal-50 px-2 py-1 rounded-full"><i class="fas fa-circle-notch fa-spin mr-1"></i> AI åˆ†æé‹ç®—ä¸­...</span></div>
        <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 flex gap-3"><div class="text-blue-500 text-xl"><i class="fas fa-info-circle"></i></div><div class="text-xs text-blue-800 leading-relaxed"><strong>é˜¿å²³å°å®åš€ï¼š</strong> è«‹å¾ã€Œåœè»Šé»ã€èµ°åˆ°ã€Œå®¶é–€å£ã€èµ°ä¸€éã€‚<br>é‡åˆ°<strong>ä¸åŒéšœç¤™</strong>å†æ‹ç…§ã€‚<span class="text-red-500 font-bold">è«‹å‹¿é‡è¤‡æ‹æ”</span>ã€‚</div></div>
        <div><label class="text-sm font-bold text-gray-800 block mb-1 flex items-center"><span class="bg-gray-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2">A</span>å±‹å…§ç“¶é ¸ (é–€/çª—/æ¨“æ¢¯)</label><p class="text-[10px] text-gray-400 mb-3 pl-7"><i class="fas fa-arrow-right text-gray-300 mr-1"></i> æ‹æ”æº–å‰‡ï¼šé æƒ³å¤§å‹å‚¢ä¿±è·¯å¾‘ã€‚è‹¥æœ‰å¯¬åº¦&lt;80cmé–€æ¡†ã€è½‰è§’ã€æ¨“æ¢¯é›œç‰©æˆ–é è¨ˆåŠæ›çª—å£ï¼Œè«‹æ‹æ”ã€‚<br><i class="fas fa-image text-gray-300 mr-1"></i> é™åˆ¶ï¼š1 ~ 12 å¼µ</p><div class="photo-scroll-container pl-7" id="container-indoor"><label class="add-photo-btn group"><input type="file" class="hidden" accept="image/*" multiple onchange="handleMultiPhoto(this, 'indoor', 12)"><i class="fas fa-plus text-2xl mb-1 text-gray-300 group-hover:text-brand-teal transition"></i><span class="text-[10px] text-gray-400">æ–°å¢</span></label></div></div>
        <div><label class="text-sm font-bold text-gray-800 block mb-1 flex items-center"><span class="bg-gray-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2">B</span>å¤–éƒ¨æ¨é‹ (ä¸­åº­/å¤§å»³/è»Šé“)</label><p class="text-[10px] text-gray-400 mb-3 pl-7"><i class="fas fa-arrow-right text-gray-300 mr-1"></i> æ‹æ”æº–å‰‡ï¼šæ²¿é€”è‹¥æœ‰ã€Œå°éšã€ã€ã€Œæ–œå¡ã€ã€ã€Œä¸Šä¸‹éšæ¢¯ã€ã€ã€Œé•·èµ°å»Š(&gt;30m)ã€è«‹æ‹æ”ã€‚<br><i class="fas fa-image text-gray-300 mr-1"></i> é™åˆ¶ï¼š1 ~ 12 å¼µ</p><div class="photo-scroll-container pl-7" id="container-path"><label class="add-photo-btn group"><input type="file" class="hidden" accept="image/*" multiple onchange="handleMultiPhoto(this, 'path', 12)"><i class="fas fa-plus text-2xl mb-1 text-gray-300 group-hover:text-brand-teal transition"></i><span class="text-[10px] text-gray-400">æ–°å¢</span></label></div></div>
        <div><label class="text-sm font-bold text-gray-800 block mb-1 flex items-center"><span class="bg-gray-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2">C</span>è²¨è»Šåœé é»</label><p class="text-[10px] text-gray-400 mb-3 pl-7"><i class="fas fa-arrow-right text-gray-300 mr-1"></i> æ‹æ”æº–å‰‡ï¼šè²¨è»Šåœé ä½ç½®ã€ä¸Šæ–¹é®é›¨æ£šã€‚<br><i class="fas fa-image text-gray-300 mr-1"></i> é™åˆ¶ï¼š1 ~ 4 å¼µ</p><div class="photo-scroll-container pl-7" id="container-park"><label class="add-photo-btn group"><input type="file" class="hidden" accept="image/*" multiple onchange="handleMultiPhoto(this, 'park', 4)"><i class="fas fa-plus text-2xl mb-1 text-gray-300 group-hover:text-brand-teal transition"></i><span class="text-[10px] text-gray-400">æ–°å¢</span></label></div></div>
        <button class="w-full py-4 bg-brand-yellow text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition flex items-center justify-center gap-2 group btn-ai-action" onclick="runAiAnalysis(this)">
            <i class="fas fa-magic text-xl group-hover:animate-pulse"></i> <span>é»æˆ‘é–‹å§‹ AI è¾¨è­˜å‹•ç·š</span>
        </button>
      </div>
      <div class="mt-6 hidden ai-result-box transition-all duration-500 ease-out opacity-0 translate-y-4">
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="bg-white border border-gray-100 p-3 rounded-2xl shadow-sm group"><div class="flex justify-between"><label class="text-[10px] font-bold text-gray-400 block mb-1">ä¸­åº­æ¨é‹(>30m)</label><i class="fas fa-walking text-gray-100"></i></div><div class="flex items-baseline gap-1"><input type="number" class="dist-input w-full bg-transparent text-xl font-bold text-brand-dark outline-none p-0" value="0" min="0"><span class="text-xs text-gray-400 font-medium">å€æ®µ</span></div></div>
          <div class="bg-white border border-gray-100 p-3 rounded-2xl shadow-sm group"><div class="flex justify-between"><label class="text-[10px] font-bold text-gray-400 block mb-1">å‹•ç·šéšæ¢¯</label><i class="fas fa-stream text-gray-100"></i></div><div class="flex items-baseline gap-1"><input type="number" class="stairs-input w-full bg-transparent text-xl font-bold text-brand-dark outline-none p-0" value="0" min="0"><span class="text-xs text-gray-400 font-medium">è™•</span></div></div>
          <div class="bg-white border border-gray-100 p-3 rounded-2xl shadow-sm group"><div class="flex justify-between"><label class="text-[10px] font-bold text-gray-400 block mb-1">é›»æ¢¯è½‰ä¹˜</label><i class="fas fa-exchange-alt text-gray-100"></i></div><div class="flex items-baseline gap-1"><input type="number" class="transfer-input w-full bg-transparent text-xl font-bold text-brand-dark outline-none p-0" value="0" min="0"><span class="text-xs text-gray-400 font-medium">æ¬¡</span></div></div>
          <div class="bg-white border border-gray-100 p-3 rounded-2xl shadow-sm group"><div class="flex justify-between"><label class="text-[10px] font-bold text-gray-400 block mb-1">å»ºè­°åŠè»Š</label><i class="fas fa-truck-pickup text-gray-100"></i></div><div class="flex items-baseline gap-1"><input type="number" class="crane-input w-full bg-transparent text-xl font-bold text-brand-dark outline-none p-0" value="0" min="0"><span class="text-xs text-gray-400 font-medium">Hr</span></div></div>
        </div>
        <div class="crane-alert hidden mb-4 bg-red-50 border border-red-100 p-3 rounded-xl flex items-start gap-3 animate-pulse"><div class="text-red-500 mt-0.5"><i class="fas fa-exclamation-triangle"></i></div><div class="text-xs text-red-800"><strong class="block mb-0.5">AI å»ºè­°ä½¿ç”¨åŠè»Š</strong><span class="crane-reason opacity-80"></span></div></div>
        <div class="relative bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden group focus-within:ring-2 focus-within:ring-brand-yellow/30 transition-all duration-300"><div class="absolute left-0 top-0 bottom-0 w-1.5 bg-brand-yellow"></div><div class="p-4 pl-6"><label class="flex items-center gap-2 text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide"><i class="fas fa-clipboard-list text-brand-teal"></i> æ¬é‹å›°é›£é»å‚™è¨»</label><textarea class="risk-note w-full text-sm text-gray-700 leading-relaxed outline-none resize-none bg-transparent placeholder-gray-300 font-medium" rows="3" placeholder="AI åˆ†æä¸­..."></textarea></div></div>
      </div>
    </div>
  </template>

  <template id="tpl-packing-area">
    <div class="dynamic-card packing-card relative" data-id="">
      <div class="card-header" onclick="toggleCard(this)">
        <i class="toggle-icon fas fa-chevron-right"></i>
        <span class="card-title text-lg font-bold text-brand-dark ml-2">æ–°æ‰“åŒ…å€åŸŸ</span>
        <span class="card-summary ml-2 text-xs text-gray-500"></span>
        <div class="card-actions">
            <button class="btn-card-action" onclick="copyCard(event, this)"><i class="fas fa-copy"></i></button>
            <button class="btn-card-action delete" onclick="removeCard(event, this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="px-6 py-2 text-xs text-gray-400 card-collapsed-info hidden border-b border-gray-100 bg-gray-50/50">
        <span class="info-text">å°šæœªè¨­å®šè·¯ç·š (é»æ“Šå±•é–‹è¨­å®š)</span>
      </div>
      <div class="card-body hidden">
        <div class="mb-4">
           <label class="block text-xs font-bold mb-1 text-gray-500">å€åŸŸåç¨±</label>
           <input type="text" class="area-name-input input-field py-2 w-full bg-gray-50 border border-gray-200 rounded-lg" value="æ–°å€åŸŸ" oninput="updateCardTitle(this)">
        </div>
        <div class="bg-brand-teal/5 p-3 rounded-lg border border-brand-teal/10 mb-3">
           <div class="flex items-center mb-2"><span class="bg-brand-teal text-white text-[10px] px-2 py-0.5 rounded-full font-bold mr-2">FROM</span><span class="text-xs font-bold text-gray-600">æ¬å‡ºè¨­å®š</span></div>
           <div class="grid grid-cols-2 gap-2">
             <div><label class="text-[10px] text-gray-400 block mb-1">åœ°é»</label><select class="select-field py-1 w-full text-sm move-out-select" onchange="updateFloorSelect(this, 'out'); updateCollapsedInfo(this)"><option value="">é¸æ“‡åœ°é»</option></select></div>
             <div><label class="text-[10px] text-gray-400 block mb-1">æ¨“å±¤</label><select class="select-field py-1 w-full text-sm move-out-floor-select" onchange="updateCollapsedInfo(this)"><option value="">(å…ˆé¸åœ°é»)</option></select></div>
           </div>
        </div>
        <div class="bg-brand-yellow/5 p-3 rounded-lg border border-brand-yellow/10 mb-4">
           <div class="flex items-center mb-2"><span class="bg-brand-yellow text-white text-[10px] px-2 py-0.5 rounded-full font-bold mr-2">TO</span><span class="text-xs font-bold text-gray-600">æ¬å…¥è¨­å®š</span></div>
           <div class="grid grid-cols-2 gap-2">
             <div><label class="text-[10px] text-gray-400 block mb-1">åœ°é»</label><select class="select-field py-1 w-full text-sm move-in-select" onchange="updateFloorSelect(this, 'in'); updateCollapsedInfo(this)"><option value="">é¸æ“‡åœ°é»</option></select></div>
             <div><label class="text-[10px] text-gray-400 block mb-1">æ¨“å±¤</label><select class="select-field py-1 w-full text-sm move-in-floor-select" onchange="updateCollapsedInfo(this)"><option value="">(å…ˆé¸åœ°é»)</option></select></div>
           </div>
        </div>
        <div class="mb-4 border-t border-dashed border-gray-200 pt-4">
          <div class="photo-scroll-container" id="container-packing"><label class="add-photo-btn group"><input type="file" class="hidden" accept="image/*" multiple onchange="handlePackingPhoto(this)"><i class="fas fa-camera text-xl mb-1 group-hover:text-brand-teal transition"></i><span class="text-[10px] text-gray-400">æ–°å¢</span></label></div>
        </div>
        <button class="w-full py-2 bg-brand-teal/10 text-brand-teal font-bold rounded-lg border border-brand-teal hover:bg-brand-teal hover:text-white transition btn-ai-action" onclick="runPackingAnalysis(this)"><i class="fas fa-magic"></i> <span>AI ç›¤é»é›œç‰©</span></button>
        <div class="item-list mt-4 space-y-3 hidden"></div>
      </div>
    </div>
  </template>

  <template id="tpl-area-card">
    <div class="dynamic-card area-card relative" data-id="">
      <div class="card-header" onclick="toggleCard(this)">
        <i class="toggle-icon fas fa-chevron-right"></i>
        <span class="card-title text-lg font-bold text-brand-dark ml-2">æ–°å€åŸŸ</span>
        <span class="card-summary ml-2 text-xs text-gray-500"></span>
        <div class="card-actions">
            <button class="btn-card-action" onclick="copyCard(event, this)"><i class="fas fa-copy"></i></button>
            <button class="btn-card-action delete" onclick="removeAreaCard(event, this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="px-6 py-2 text-xs text-gray-400 card-collapsed-info hidden border-b border-gray-100 bg-gray-50/50">
        <span class="info-text">å°šæœªè¨­å®šè·¯ç·š (é»æ“Šå±•é–‹è¨­å®š)</span>
      </div>
      <div class="card-body hidden">
        <div class="mb-4">
           <label class="block text-xs font-bold mb-1 text-gray-500">å€åŸŸåç¨±</label>
           <input type="text" class="area-name-input input-field py-2 w-full bg-gray-50 border border-gray-200 rounded-lg" value="æ–°å€åŸŸ" oninput="updateCardTitle(this)">
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="bg-gray-50 p-2 rounded-lg border border-gray-200">
            <span class="bg-brand-teal text-white text-[10px] px-2 py-0.5 rounded-full font-bold mb-1 inline-block">FROM</span> <span class="text-xs font-bold text-gray-600">æ¬å‡ºè¨­å®š</span>
            <div class="mt-2 space-y-2">
               <div><label class="text-[10px] text-gray-400 block mb-1">åœ°é»</label><select class="select-field py-1 w-full text-sm area-move-out-select" onchange="updateAreaRoute(this)"><option value="">é¸æ“‡åœ°é»</option></select></div>
               <div><label class="text-[10px] text-gray-400 block mb-1">æ¨“å±¤</label><select class="select-field py-1 w-full text-sm area-out-floor-select" onchange="updateAreaSummaryText(this)"><option value="">(å…ˆé¸åœ°é»)</option></select></div>
            </div>
          </div>
          <div class="bg-gray-50 p-2 rounded-lg border border-gray-200">
            <span class="bg-brand-yellow text-white text-[10px] px-2 py-0.5 rounded-full font-bold mb-1 inline-block">TO</span> <span class="text-xs font-bold text-gray-600">æ¬å…¥è¨­å®š</span>
            <div class="mt-2 space-y-2">
               <div><label class="text-[10px] text-gray-400 block mb-1">åœ°é»</label><select class="select-field py-1 w-full text-sm area-move-in-select" onchange="updateAreaRoute(this)"><option value="">é¸æ“‡åœ°é»</option></select></div>
               <div><label class="text-[10px] text-gray-400 block mb-1">æ¨“å±¤</label><select class="select-field py-1 w-full text-sm area-in-floor-select" onchange="updateAreaSummaryText(this)"><option value="">(å…ˆé¸åœ°é»)</option></select></div>
            </div>
          </div>
        </div>
        <div class="mb-4 border-t border-dashed border-gray-200 pt-4">
          <div class="photo-scroll-container area-photo-container">
             <label class="add-photo-btn group">
               <input type="file" class="hidden" accept="image/*" multiple onchange="handleAreaPhoto(this)">
               <i class="fas fa-camera text-xl mb-1 group-hover:text-brand-primary transition"></i>
               <span class="text-[10px] text-gray-400">æ–°å¢</span>
             </label>
          </div>
        </div>
        <button class="w-full py-3 bg-brand-primary/10 text-brand-dark font-bold rounded-lg border border-brand-primary hover:bg-brand-primary hover:text-white transition btn-recognize btn-ai-action" onclick="runAreaRecognition(this)">
          <i class="fas fa-magic mr-1"></i> <span>é–‹å§‹è¾¨è­˜æ¬é‹ç‰©</span>
        </button>
        <div class="item-list mt-4 space-y-3 hidden"></div>
      </div>
    </div>
  </template>

  <template id="tpl-ai-item-row">
    <div class="item-card relative group bg-white shadow-sm mt-3 border border-gray-200 rounded-xl overflow-hidden">
      <div class="item-header flex justify-between items-start" onclick="toggleAiItem(this)">
         <div class="flex items-start flex-1">
            <i class="item-arrow-icon fas fa-chevron-right mt-1"></i>
            <div>
               <div class="item-title-block flex items-baseline">
                  <span class="item-name">ç‰©å“åç¨±</span>
                  <span class="text-xs text-gray-400 mx-1">x</span>
                  <span class="item-qty">1</span>
               </div>
               <div class="item-tags-row"></div>
            </div>
         </div>
         <div class="item-actions">
            <button class="btn-icon-sm copy" onclick="copyAiItem(event, this)"><i class="fas fa-copy"></i></button>
            <button class="btn-icon-sm delete" onclick="deleteAiItem(event, this)"><i class="fas fa-times"></i></button>
         </div>
      </div>
      <div class="item-body">
         <div class="space-y-4">
            <div><label class="text-xs font-bold text-gray-500 block mb-1">åç¨±</label><input type="text" class="input-field py-2 inp-name" oninput="updateAiItemDisplay(this)"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">æ•¸é‡</label><input type="number" class="input-field py-2 inp-qty" oninput="updateAiItemDisplay(this)"></div>
            <div class="grid grid-cols-2 gap-3">
               <div><label class="text-xs font-bold text-gray-500 block mb-1">é¡å‹</label><input type="text" class="input-field py-2 inp-type" oninput="updateAiItemDisplay(this)"></div>
               <div><label class="text-xs font-bold text-gray-500 block mb-1">æè³ª</label><input type="text" class="input-field py-2 inp-material" oninput="updateAiItemDisplay(this)"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
               <div>
                  <label class="text-xs font-bold text-gray-500 block mb-1">æ¬é‹é›£æ˜“åº¦</label>
                  <select class="select-field py-2 inp-difficulty" onchange="updateAiItemDisplay(this)">
                     <option value="ä¸€äººå¯æ¬">ä¸€äººå¯æ¬</option>
                     <option value="äºŒäººå¯æ¬">äºŒäººå¯æ¬</option>
                     <option value="ä¸€äººæŠ€è¡“æ¬">ä¸€äººæŠ€è¡“æ¬</option>
                     <option value="äºŒäººæŠ€è¡“æ¬">äºŒäººæŠ€è¡“æ¬</option>
                     <option value="ç‰¹æ®ŠæŠ€æ³•æ¬">ç‰¹æ®ŠæŠ€æ³•æ¬</option>
                  </select>
               </div>
               <div>
                  <label class="text-xs font-bold text-gray-500 block mb-1">æ‹†è£éœ€æ±‚</label>
                  <select class="select-field py-2 inp-disassembly" onchange="updateAiItemDisplay(this)">
                     <option value="ç„¡éœ€æ‹†è£">ç„¡éœ€æ‹†è£</option>
                     <option value="ç°¡æ˜“æ‹†è£">ç°¡æ˜“æ‹†è£</option>
                     <option value="è¤‡é›œæ‹†è£">è¤‡é›œæ‹†è£</option>
                     <option value="ç³»çµ±æ‹†è£">ç³»çµ±æ‹†è£</option>
                     <option value="ç‰¹æŠ€æ‹†è£">ç‰¹æŠ€æ‹†è£</option>
                  </select>
               </div>
            </div>
            <div>
               <label class="text-xs font-bold text-red-500 block mb-1">é¢¨éšªæç¤º (å¯ç·¨è¼¯)</label>
               <textarea class="input-field py-2 inp-risknote text-red-700 bg-red-50 border-red-200 focus:border-red-400" rows="2" oninput="updateAiItemDisplay(this)"></textarea>
            </div>
         </div>
      </div>
      <div class="item-risk-bar hidden"></div>
    </div>
  </template>

<script>
    // ==========================================
    // ã€é‡è¦ã€‘GitHub Pages å°ˆç”¨è¨­å®š
    // è«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›¿æ›æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€ (Web App URL)
    // ==========================================
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz7lv9ntbB2Bvpng1DO31Kn8-WRyveoUIwuCyMs2ydC3LdGtGnGbPnrenyc-ff7zpKInw/exec";

// å¼·éŸŒç‰ˆ API å‘¼å«å‡½å¼ (é…åˆå¾Œç«¯ Text/Plain ç­–ç•¥)
    async function callBackendAPI(action, data = {}) {
        if (!GAS_API_URL || GAS_API_URL.includes("ä½ çš„_DEPLOYMENT_ID")) {
            alert("è«‹å…ˆè¨­å®šæ­£ç¢ºçš„ GAS_API_URLï¼");
            throw new Error("API URL æœªè¨­å®š");
        }

        // å»ºæ§‹æ¨™æº– Payload
        const payload = JSON.stringify({ action: action, ...data });

        try {
            // ä½¿ç”¨ fetch ç™¼é€è«‹æ±‚
            const response = await fetch(GAS_API_URL, {
                method: "POST",
                // ã€é—œéµã€‘ä½¿ç”¨ text/plainï¼Œé¿å…è§¸ç™¼è¤‡é›œçš„ CORS Preflight (OPTIONS)
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: payload,
                // ã€é—œéµã€‘è¨­å®š redirect ç‚º followï¼Œç¢ºä¿è‡ªå‹•è·Ÿéš¨ GAS çš„ 302 è·³è½‰
                redirect: "follow"
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // å…ˆè®€å–ç´”æ–‡å­—
            const textResult = await response.text();

            // å˜—è©¦è§£æ JSON
            try {
                const jsonResult = JSON.parse(textResult);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ‡‰ç”¨å±¤ç´šçš„éŒ¯èª¤
                if (jsonResult && jsonResult.error) {
                    console.error("å¾Œç«¯åŸ·è¡ŒéŒ¯èª¤:", jsonResult.error);
                    // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦ alertï¼Œæˆ–è€…ç›´æ¥å›å‚³è®“å¤–å±¤è™•ç†
                    return jsonResult; 
                }
                
                return jsonResult;

            } catch (e) {
                // å¦‚æœè§£æå¤±æ•—ï¼Œé€šå¸¸æ˜¯å› ç‚º Google å›å‚³äº† HTML ç™»å…¥é é¢
                console.error("JSON è§£æå¤±æ•—ï¼ŒåŸå§‹å›æ‡‰:", textResult);
                
                // é€™è£¡æ˜¯ä¸€å€‹ã€Œå¤šé‡å¸³è™Ÿç™»å…¥ã€çš„å¸¸è¦‹ Bug æç¤º
                if (textResult.includes("<!DOCTYPE html>") || textResult.includes("Google Accounts")) {
                    alert("âš ï¸ ç³»çµ±åµæ¸¬åˆ°å¸³è™Ÿè¡çªï¼\n\nGoogle å®‰å…¨æ©Ÿåˆ¶æ“‹ä½äº†é€£ç·šã€‚\nè«‹å˜—è©¦ï¼š\n1. ä½¿ç”¨ã€Œç„¡ç—•è¦–çª—ã€é–‹å•Ÿæ­¤ç¶²é ã€‚\n2. æˆ–ç™»å‡ºç€è¦½å™¨ä¸­å…¶ä»–çš„ Google å¸³è™Ÿã€‚");
                } else {
                    alert("è³‡æ–™å‚³è¼¸ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
                throw new Error("API å›æ‡‰éæœ‰æ•ˆ JSON");
            }

        } catch (error) {
            console.error("ç¶²è·¯é€£ç·šå±¤ç´šéŒ¯èª¤:", error);
            // é€™è£¡ä¸å† alertï¼Œå› ç‚ºä¸Šé¢çš„ try-catch å·²ç¶“è™•ç†éäº†
            throw error;
        }
    }

    // ==========================================
    // 1. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–
    // ==========================================
    let currentStep = 0;
    const userData = { basic: {}, locations: [], packing: {}, areas: [], notes: '', quoteResult: null };
    let locCounts = { out: 0, in: 0 };
    let cardImages = {}; 
    let locationOptions = { out: [], in: [] }; 
    let areaFilesStore = new Map();

    // ç°½åæ¿è®Šæ•¸
    let signaturePad = { canvas: null, ctx: null, isDrawing: false };

    const TAIWAN_DATA = { 
        "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
        "è‡ºåŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
        "æ–°åŒ—å¸‚": ["è¬é‡Œå€", "é‡‘å±±å€", "æ¿æ©‹å€", "æ±æ­¢å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "ç‘èŠ³å€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "æ–°åº—å€", "åªæ—å€", "çƒä¾†å€", "æ°¸å’Œå€", "ä¸­å’Œå€", "åœŸåŸå€", "ä¸‰å³½å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰é‡å€", "æ–°èŠå€", "æ³°å±±å€", "æ—å£å€", "è˜†æ´²å€", "äº”è‚¡å€", "å…«é‡Œå€", "æ·¡æ°´å€", "ä¸‰èŠå€", "çŸ³é–€å€"],
        "æ¡ƒåœ’å¸‚": ["ä¸­å£¢å€", "å¹³é®å€", "é¾æ½­å€", "æ¥Šæ¢…å€", "æ–°å±‹å€", "è§€éŸ³å€", "æ¡ƒåœ’å€", "é¾œå±±å€", "å…«å¾·å€", "å¤§æºªå€", "å¾©èˆˆå€", "å¤§åœ’å€", "è˜†ç«¹å€"],
        "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
        "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "æ¹–å£é„‰", "æ–°è±é„‰", "æ–°åŸ”é®", "é—œè¥¿é®", "èŠæ—é„‰", "å¯¶å±±é„‰", "ç«¹æ±é®", "äº”å³°é„‰", "æ©«å±±é„‰", "å°–çŸ³é„‰", "åŒ—åŸ”é„‰", "å³¨çœ‰é„‰"],
        "è‹—æ —ç¸£": ["ç«¹å—é®", "é ­ä»½å¸‚", "ä¸‰ç£é„‰", "å—åº„é„‰", "ç…æ½­é„‰", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "è‹—æ —å¸‚", "é€ æ©‹é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "å¤§æ¹–é„‰", "æ³°å®‰é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "è¥¿æ¹–é„‰", "å“è˜­é®"],
        "è‡ºä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
        "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "èŠ¬åœ’é„‰", "èŠ±å£‡é„‰", "ç§€æ°´é„‰", "é¹¿æ¸¯é®", "ç¦èˆˆé„‰", "ç·šè¥¿é„‰", "å’Œç¾é®", "ä¼¸æ¸¯é„‰", "å“¡æ—å¸‚", "ç¤¾é ­é„‰", "æ°¸é–é„‰", "åŸ”å¿ƒé„‰", "æºªæ¹–é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "ç”°ä¸­é®", "åŒ—æ–—é®", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "æºªå·é„‰", "ç«¹å¡˜é„‰", "äºŒæ—é®", "å¤§åŸé„‰", "èŠ³è‹‘é„‰", "äºŒæ°´é„‰"],
        "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "ä¸­å¯®é„‰", "è‰å±¯é®", "åœ‹å§“é„‰", "åŸ”é‡Œé®", "ä»æ„›é„‰", "åé–“é„‰", "é›†é›†é®", "æ°´é‡Œé„‰", "é­šæ± é„‰", "ä¿¡ç¾©é„‰", "ç«¹å±±é®", "é¹¿è°·é„‰"],
        "é›²æ—ç¸£": ["æ–—å—é®", "å¤§åŸ¤é„‰", "è™å°¾é®", "åœŸåº«é®", "è¤’å¿ é„‰", "æ±å‹¢é„‰", "è‡ºè¥¿é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ–—å…­å¸‚", "æ—å…§é„‰", "å¤å‘é„‰", "è¿æ¡é„‰", "è¥¿èºé®", "äºŒå´™é„‰", "åŒ—æ¸¯é®", "æ°´æ—é„‰", "å£æ¹–é„‰", "å››æ¹–é„‰", "å…ƒé•·é„‰"],
        "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
        "å˜‰ç¾©ç¸£": ["ç•ªè·¯é„‰", "æ¢…å±±é„‰", "ç«¹å´é„‰", "é˜¿é‡Œå±±é„‰", "ä¸­åŸ”é„‰", "å¤§åŸ”é„‰", "æ°´ä¸Šé„‰", "é¹¿è‰é„‰", "å¤ªä¿å¸‚", "æœ´å­å¸‚", "æ±çŸ³é„‰", "å…­è…³é„‰", "æ–°æ¸¯é„‰", "æ°‘é›„é„‰", "å¤§æ—é®", "æºªå£é„‰", "ç¾©ç«¹é„‰", "å¸ƒè¢‹é®"],
        "è‡ºå—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
        "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "æ±æ²™ç¾¤å³¶", "å—æ²™ç¾¤å³¶", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
        "å±æ±ç¸£": ["å±æ±å¸‚", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ç«¹ç”°é„‰", "å…§åŸ”é„‰", "è¬ä¸¹é„‰", "æ½®å·é®", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "è¬å·’é„‰", "å´é ‚é„‰", "æ–°åŸ¤é„‰", "å—å·é„‰", "æ—é‚Šé„‰", "æ±æ¸¯é®", "ç‰çƒé„‰", "ä½³å†¬é„‰", "æ–°åœ’é„‰", "æ‹å¯®é„‰", "æ‹å±±é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "è»ŠåŸé„‰", "ç‰¡ä¸¹é„‰", "æ†æ˜¥é®", "æ»¿å·é„‰"],
        "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "ç¾…æ±é®", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "äº”çµé„‰", "å†¬å±±é„‰", "è˜‡æ¾³é®", "å—æ¾³é„‰"],
        "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "æ–°åŸé„‰", "ç§€æ—é„‰", "å‰å®‰é„‰", "å£½è±é„‰", "é³³æ—é®", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "è¬æ¦®é„‰", "ç‰é‡Œé®", "å“æºªé„‰", "å¯Œé‡Œé„‰"],
        "è‡ºæ±ç¸£": ["è‡ºæ±å¸‚", "ç¶ å³¶é„‰", "è˜­å¶¼é„‰", "å»¶å¹³é„‰", "å‘å—é„‰", "é¹¿é‡é„‰", "é—œå±±é®", "æµ·ç«¯é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "æˆåŠŸé®", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "é‡‘å³°é„‰", "å¤§æ­¦é„‰", "é”ä»é„‰"],
        "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰", "ç™½æ²™é„‰", "æ¹–è¥¿é„‰"],
        "é‡‘é–€ç¸£": ["é‡‘æ²™é®", "é‡‘æ¹–é®", "é‡‘å¯§é„‰", "é‡‘åŸé®", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
        "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
    };

    document.addEventListener('DOMContentLoaded', () => {
      const dateInput = document.getElementById('input-date');
      if(dateInput) dateInput.min = new Date().toISOString().split('T')[0];
      loadFromStorage();
      
      // åˆå§‹åŒ–é è¨­å¡ç‰‡
      addLocation('out'); addLocation('in');
      addPackingArea(); addAreaCard();
    });

// ==========================================
    // 2. æ­¥é©Ÿå°èˆª (å–®æ©Ÿå¼·åˆ¶é€šè¡Œç‰ˆ - çµ‚æ¥µä¿®æ­£)
    // ==========================================
    async function nextStep() { 
        if (currentStep === 0) { 
            // --- Step 0: åŸºæœ¬è³‡æ–™æ”¶é›† ---
            const name = document.getElementById('input-name').value; 
            const email = document.getElementById('input-email').value;
            const date = document.getElementById('input-date').value; 
            const type = document.getElementById('input-type').value;
            const referrer = document.getElementById('input-referrer').value;

            if(!name || !date || !email || !type) return alert('è«‹å¡«å¯«å®Œæ•´åŸºæœ¬è³‡è¨Š'); 
            
            // å¼·åˆ¶æª¢æŸ¥æ˜¯å¦æœ‰è¼¸å…¥ä»£ç¢¼
            if(!referrer) return alert('è«‹è¼¸å…¥æœƒå“¡ä»£ç¢¼æ‰èƒ½ç¹¼çºŒï¼');

            // ğŸŸ¢ã€ä¿®æ”¹é‡é»ã€‘ï¼šå¼·åˆ¶é€šè¡Œï¼Œè·³éå¾Œç«¯æª¢æŸ¥ï¼Œé¿å… 302 éŒ¯èª¤
            console.log("å¼·åˆ¶é€šè¡Œï¼šè·³éä»£ç¢¼æª¢æŸ¥ï¼Œç›´æ¥é€²å…¥ Step 1");
            proceedToStep1(name, email, date, type, referrer);
            return; 
        }
        
        else if (currentStep === 1) { 
            userData.locations = getStep1Data(); 
            const outs = userData.locations.filter(l => l.type === 'out'); 
            const ins = userData.locations.filter(l => l.type === 'in'); 
            if(outs.length === 0 || ins.length === 0) return alert('è«‹è‡³å°‘è¨­å®šä¸€å€‹æ¬å‡ºåœ°èˆ‡ä¸€å€‹æ¬å…¥åœ°'); 
            
            // ğŸŸ¢ã€ä¿®æ”¹é‡é»ã€‘ï¼šè¨»è§£æ‰è‡ªå‹•å­˜æª”ï¼Œé¿å…èƒŒæ™¯å ±éŒ¯
            // autoSaveProgress(1); 

            updateLocationOptions(userData.locations); 
            updateStep3Dropdowns(); 
            goToStep(2); 
        } else if (currentStep === 2) { 
            calcStep2Total(); 
            // ğŸŸ¢ã€ä¿®æ”¹é‡é»ã€‘ï¼šè¨»è§£æ‰è‡ªå‹•å­˜æª”
            // autoSaveProgress(2); 
            goToStep(3); 
        } else if (currentStep === 3) { 
            const areas = document.querySelectorAll('.area-card'); 
            if(areas.length === 0) return alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹å€åŸŸ (å¦‚ï¼šè‡¥å®¤)'); 
            
            // ğŸŸ¢ã€ä¿®æ”¹é‡é»ã€‘ï¼šè¨»è§£æ‰è‡ªå‹•å­˜æª”
            // autoSaveProgress(3); 
            goToStep(4); 
        } else if (currentStep === 4) {
            const btn = document.querySelector('#step-4 .btn-main');
            // æ³¨æ„ï¼šé€™è£¡é‚„æ˜¯æœƒå‘¼å«å¾Œç«¯é€²è¡Œã€Œä¼°åƒ¹è¨ˆç®—ã€ï¼Œä½†å› ç‚ºå‰é¢æ²’æœ‰å ±éŒ¯äº†ï¼Œé€™è£¡æˆåŠŸç‡æœƒè®Šé«˜
            handleSubmitEstimation(btn);
        } else if (currentStep === 5) {
            document.getElementById('main-footer').style.display = 'none';
            goToStep(6); 
            
            // ğŸŸ¢ã€ä¿®æ”¹é‡é»ã€‘ï¼šå¦‚æœç”ŸæˆæŒ‡å—ä¹Ÿæœƒå ±éŒ¯ï¼Œå»ºè­°å…ˆæŠŠä¸‹é¢é€™è¡Œè¨»è§£æ‰æ¸¬è©¦
            generateGuide(); 
            
            setTimeout(initSignaturePad, 500);
        }
    }

    function proceedToStep1(name, email, date, type, referrer) {
        let urgency = "normal"; 
        if (date) { const d = getDiffDays(date); if(d<3) urgency="critical"; else if(d<7) urgency="urgent"; } 
        
        userData.basic = { name, email, date, type, referrer, urgency }; 
        localStorage.setItem('ayue_user_info', JSON.stringify(userData.basic)); 
        
        // ğŸŸ¢ã€ä¿®æ”¹é‡é»ã€‘ï¼šè¨»è§£æ‰è‡ªå‹•å­˜æª”
        // autoSaveProgress(0); 
        goToStep(1); 
    }

    function prevStep() { 
        if (currentStep === 6) {
             document.getElementById('main-footer').style.display = 'block';
             goToStep(5);
             return;
        }
        if(currentStep > 0) goToStep(currentStep - 1); 
    }
      
    function goToStep(step) { 
        const targetEl = document.getElementById(`step-${step}`);
        if (targetEl) {
            targetEl.classList.add('active'); 
            targetEl.style.display = 'block';
            setTimeout(() => {
                targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        currentStep = step; 
        
        if (currentStep === 6) {
            const step5 = document.getElementById('step-5');
            if (step5) {
                step5.classList.add('active', 'step-5-readonly');
                step5.style.display = 'block';
            }
            const footer = document.getElementById('main-footer');
            if(footer) footer.style.display = 'none';
        } else {
            const step5 = document.getElementById('step-5');
            if(step5) step5.classList.remove('step-5-readonly');
            const footer = document.getElementById('main-footer');
            if(footer) footer.style.display = 'block';
        }
        
        const progressBar = document.getElementById('progress-bar');
        if(progressBar) progressBar.style.width = Math.min((step + 1) * 16.6, 100) + '%'; 
        
        const btnPrev = document.getElementById('btn-prev');
        if(btnPrev) btnPrev.classList.toggle('hidden', step === 0); 
        
        const titles = ["åŸºæœ¬è³‡è¨Š", "åœ°é»èˆ‡å‹•ç·š", "æ•´ç†èˆ‡æ‰“åŒ…", "æ¬é‹ç‰©ä»¶", "å‚™è¨»èˆ‡çµç®—", "ä¼°åƒ¹çµæœ", "æ¬å®¶æŒ‡å—"]; 
        const pageTitle = document.getElementById('page-title');
        if(pageTitle && titles[step]) pageTitle.innerText = titles[step]; 
        
        updateBtnText();
    }

    function updateBtnText() {
        const btnMain = document.getElementById('btn-text-main');
        const btnSub = document.getElementById('btn-text-sub');
        if (!btnMain) return;
        
        if (currentStep === 0) { btnMain.innerText='GO'; btnSub.innerText='ä¸‹ä¸€æ­¥ï¼šåœ°é»èˆ‡å‹•ç·š'; }
        else if (currentStep === 1) { btnMain.innerText='GO'; btnSub.innerText='ä¸‹ä¸€æ­¥ï¼šæ‰“åŒ…æ•´ç†'; }
        else if (currentStep === 2) { btnMain.innerText='GO'; btnSub.innerText='ä¸‹ä¸€æ­¥ï¼šæ¬é‹ç‰©ä»¶'; }
        else if (currentStep === 3) { btnMain.innerText='GO'; btnSub.innerText='ä¸‹ä¸€æ­¥ï¼šå‚™è¨»çµç®—'; }
        else if (currentStep === 4) { btnMain.innerText='ç”¢ç”Ÿä¼°åƒ¹å–®'; btnSub.innerText='è¨ˆç®—è²»ç”¨æ˜ç´°'; }
        else if (currentStep === 5) { 
            btnMain.innerText = 'ä¸‹ä¸€æ­¥ï¼šç”¢å‡ºè¦åŠƒæŒ‡å—'; 
            btnSub.innerText = ''; 
        }
    }


    // ============================================================
    // ğŸ›‘ æœ€å¾Œä¸€é“é˜²ç·šï¼šå¼·åˆ¶é—œé–‰è‡ªå‹•å­˜æª” (è«‹è²¼åœ¨æª”æ¡ˆæœ€æœ«ç«¯)
    // ============================================================
    window.autoSaveProgress = function(step) {
        console.log("ğŸ›‘ [å¼·åˆ¶è¦†è“‹ç”Ÿæ•ˆ] è‡ªå‹•å­˜æª”å·²è¢«æ””æˆªï¼ŒStep:", step);
        return; // ä»€éº¼éƒ½ä¸åšï¼Œçµ•å°ä¸é€£ç¶²
    };
    console.log("âœ… è‡ªå‹•å­˜æª”åŠŸèƒ½å·²ç”±æœ«ç«¯è…³æœ¬å¼·åˆ¶é—œé–‰");


    // ==========================================
    // 3. æ ¸å¿ƒé‚è¼¯ (Core Logic - API Integrated)
    // ==========================================

    async function handleSubmitEstimation(btnElement) {
        if (btnElement) setBtnLoading(btnElement, true);

        const locMap = new Map();
        userData.locations.forEach(l => locMap.set(l.id, l));

        const areasData = Array.from(document.querySelectorAll('.area-card')).map(card => {
            const outLocId = card.querySelector('.area-move-out-select').value;
            const inLocId = card.querySelector('.area-move-in-select').value;
            let rawOutFloor = card.querySelector('.area-out-floor-select').value;
            let rawInFloor = card.querySelector('.area-in-floor-select').value;

            if (locMap.get(outLocId)?.hasElevator) rawOutFloor = 'E' + rawOutFloor;
            if (locMap.get(inLocId)?.hasElevator) rawInFloor = 'E' + rawInFloor;

            return {
                name: card.querySelector('.area-name-input').value,
                moveOutFloor: rawOutFloor,
                moveInFloor: rawInFloor,
                items: Array.from(card.querySelectorAll('.item-card')).map(row => ({
                    name: row.querySelector('.inp-name').value,
                    qty: row.querySelector('.inp-qty').value,
                    type: row.querySelector('.inp-type').value,
                    material: row.querySelector('.inp-material').value,
                    difficulty: row.querySelector('.inp-difficulty').value,
                    disassembly: row.querySelector('.inp-disassembly').value,
                    riskNote: row.querySelector('.inp-risknote').value,
                    moveOutFloor: rawOutFloor, 
                    moveInFloor: rawInFloor
                }))
            };
        });

        const buyBoxesVal = parseInt(document.getElementById('material-box').value) || 0;
        const buyBubbleVal = parseInt(document.getElementById('material-bubble').value) || 0;
        const aiTotalBoxes = userData.packing.totalBoxes || 0;

        const requestData = {
            locations: [
                ...userData.locations.filter(l => l.type === 'out').map(l => ({ 
                    ...l, type: 'move-out', address: l.addr,
                    specialStairs: l.stairsCount, specialDistance: l.pushUnits, 
                    specialTransfer: l.transferCount, specialCrane: l.craneHours 
                })),
                ...userData.locations.filter(l => l.type === 'in').map(l => ({ 
                    ...l, type: 'move-in', address: l.addr,
                    specialStairs: l.stairsCount, specialDistance: l.pushUnits, 
                    specialTransfer: l.transferCount, specialCrane: l.craneHours 
                }))
            ],
            areas: areasData,
            services: {
                packingBoxes: buyBoxesVal, 
                bubbleWrap: buyBubbleVal,
                preMovePacking: document.getElementById('service-pack').checked ? aiTotalBoxes : 0,
                postMoveUnpacking: document.getElementById('service-unpack').checked ? aiTotalBoxes : 0
            },
            specialNotes: document.getElementById('final-special-notes').value
        };

        try {
            // API å‘¼å«ï¼šè¨ˆç®—è²»ç”¨
            const res = await callBackendAPI('calculateFullQuote', { requestData: requestData });
            
            if (btnElement) setBtnLoading(btnElement, false);
            userData.quoteResult = res; 
            
            if (res.error) return alert('éŒ¯èª¤ï¼š' + res.error);
            showEstimationResult(res, requestData);

            setTimeout(() => {
                autoSaveProgress(5); 
            }, 500);

        } catch (err) {
            if (btnElement) setBtnLoading(btnElement, false);
        }
    }

    function showEstimationResult(res, request) {
        document.getElementById('main-footer').style.display = 'block'; 
        
        document.getElementById('result-total-fee').innerText = `$ ${res.totalFee.toLocaleString()}`;
        document.getElementById('result-trucks').innerText = `${res.baseTrucks} å°3.5å™¸è²¨è»Š`;
        document.getElementById('result-manpower').innerText = `${res.baseManpower}~${res.baseManpower+1} ä½æ¬é‹å¸«`;
        document.getElementById('result-hours').innerText = `${res.baseHours}~${res.baseHours+2} å°æ™‚`;

        const c = res.costs;
        const getItemCountsString = (counts) => { let parts = []; ["ä¸€äººå¯æ¬", "äºŒäººå¯æ¬", "ä¸€äººæŠ€è¡“æ¬", "äºŒäººæŠ€è¡“æ¬", "ç‰¹æ®ŠæŠ€æ³•æ¬"].forEach(t => { if (counts[t] > 0) parts.push(`${t} ${counts[t]}ä»¶`); }); return parts.length > 0 ? `(${parts.join(' + ')})` : ''; };
        const getDisassemblyCountsString = (counts) => { let parts = []; ["ç°¡æ˜“æ‹†è£", "è¤‡é›œæ‹†è£", "ç³»çµ±æ‹†è£", "ç‰¹æŠ€æ‹†è£"].forEach(t => { if (counts[t] > 0) parts.push(`${t} ${counts[t]}ä»¶`); }); return parts.length > 0 ? `(${parts.join(' + ')})` : ''; };

        document.getElementById('desc-base-fee').innerText = getItemCountsString(res.itemCounts);
        document.getElementById('cost-base-fee').innerText = `$ ${c.baseFee.toLocaleString()}`;
        document.getElementById('desc-stair-fee').innerText = getItemCountsString(res.stairItemCounts);
        document.getElementById('cost-stair-fee').innerText = `$ ${c.stairFee.toLocaleString()}`;
        
        let totalSpecialItems = 0; 
        request.locations.forEach(loc => { totalSpecialItems += (parseInt(loc.specialStairs)||0) + (parseInt(loc.specialDistance)||0) + (parseInt(loc.specialTransfer)||0); });
        document.getElementById('desc-special-route-fee').innerText = (totalSpecialItems > 0) ? `($ 1,000 x ${totalSpecialItems} é … x ${res.baseTrucks} è»Š)` : '';
        document.getElementById('cost-special-route-fee').innerText = `$ ${c.specialRouteFee.toLocaleString()}`;

        document.getElementById('desc-disassembly-fee').innerText = getDisassemblyCountsString(res.disassemblyItemCounts);
        document.getElementById('cost-disassembly-fee').innerText = `$ ${c.disassemblyFee.toLocaleString()}`;

        document.getElementById('desc-inter-city-fee').innerText = (res.interCityMoves > 0) ? `($ 2,000 x è·¨ ${res.interCityMoves} ç¸£å¸‚ x ${res.baseTrucks} è»Š)` : '';
        document.getElementById('cost-inter-city-fee').innerText = `$ ${c.interCityFee.toLocaleString()}`;

        let totalCraneHours = 0; request.locations.forEach(loc => { totalCraneHours += (parseInt(loc.specialCrane)||0); });
        document.getElementById('desc-crane-fee').innerText = (totalCraneHours > 0) ? `(${totalCraneHours} å°æ™‚åŠè»Šæ™‚æ•¸)` : '';
        document.getElementById('cost-crane-fee').innerText = `$ ${c.craneFee.toLocaleString()}`;

        const s = request.services;
        document.getElementById('desc-packing-fee').innerText = (parseInt(s.packingBoxes) > 0 || parseInt(s.bubbleWrap) > 0) ? `(ç´™ç®± ${s.packingBoxes} å€‹ + æ°£æ³¡å¸ƒ ${s.bubbleWrap} æ²)` : '';
        document.getElementById('cost-packing-fee').innerText = `$ ${c.packingFee.toLocaleString()}`;

        document.getElementById('desc-organizing-fee').innerText = (parseInt(s.preMovePacking) > 0 || parseInt(s.postMoveUnpacking) > 0) ? `(æ‰“åŒ… ${s.preMovePacking} ä»¶ + ä¸Šæ¶ ${s.postMoveUnpacking} ä»¶)` : '';
        document.getElementById('cost-organizing-fee').innerText = `$ ${c.organizingFee.toLocaleString()}`;

        document.getElementById('result-view-notes').innerText = res.specialNotes || "(ç„¡)";
        renderReminders(res, request);

        goToStep(5);
    }

    function renderReminders(res, req) {
        const container = document.getElementById('reminder-content');
        let html = '<div class="space-y-4">'; 

        if (res.itemCounts["ç‰¹æ®ŠæŠ€æ³•æ¬"] > 0) {
            html += `<div class="bg-red-50 border-l-4 border-red-500 p-3 rounded-r"><h4 class="font-bold text-red-700 mb-1 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i>ç‰¹æ®Šè²´é‡ç‰©å“æé†’</h4><ul class="text-sm text-red-800 space-y-1 list-none"><li class="pl-4 relative before:content-['â€¢'] before:absolute before:left-0 font-bold">æœ¬å–®åŒ…å«ã€Œç‰¹æ®ŠæŠ€æ³•ã€æ¬é‹ç‰©ä»¶ï¼Œå¼·çƒˆå»ºè­°æ‚¨<strong>é¡å¤–åŠ ä¿å•†æ¥­ä¿éšª</strong>ã€‚</li><li class="pl-4 relative before:content-['â€¢'] before:absolute before:left-0">è«‹ç¢ºèªè·¯å¾‘å¯¬åº¦èˆ‡åœ°é¢æ‰¿é‡ã€‚</li></ul></div>`;
        }
        if (res.itemCounts["ä¸€äººæŠ€è¡“æ¬"] > 0 || res.itemCounts["äºŒäººæŠ€è¡“æ¬"] > 0) {
            html += `<div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r"><h4 class="font-bold text-blue-700 mb-1 flex items-center"><i class="fas fa-shield-alt mr-2"></i>ç²¾ç·»ç‰©å“é˜²è­·</h4><ul class="text-sm text-blue-800 space-y-1 list-none"><li class="pl-4 relative before:content-['â€¢'] before:absolute before:left-0">æˆ‘å€‘æœƒä½¿ç”¨æ¯¯å­æˆ–è† è†œåŠ å¼·é˜²è­·ã€‚</li><li class="pl-4 relative before:content-['â€¢'] before:absolute before:left-0 font-bold text-orange-700">ç»ç’ƒå±¤æ¿æˆ–æ´»å‹•æŠ½å±œè«‹å‹™å¿…å–å‡ºæˆ–å›ºå®šã€‚</li></ul></div>`;
        }

        let hasNoElevatorHighFloor = false;
        let hasCrane = false;
        let hasAlley = false;
        let hasTransfer = false;
        
        req.locations.forEach(loc => {
            if (loc.floorType === 'no' && (loc.floors && loc.floors.some(f => parseInt(f.replace(/[B,F]/g,'')) >= 4))) hasNoElevatorHighFloor = true;
            if (parseInt(loc.specialCrane) > 0) hasCrane = true;
            if (parseInt(loc.specialTransfer) > 0) hasTransfer = true;
            if (loc.addr && (loc.addr.includes('å··') || loc.addr.includes('å¼„'))) hasAlley = true;
        });

        let routeHtml = '';
        if (hasCrane) routeHtml += `<li class="text-red-600 font-bold">ğŸ›‘ ä½¿ç”¨åŠè»Šï¼šè«‹ç¢ºèªé™½å°éµçª—å¯æ‹†å¸ã€æ¨“ä¸‹æœ‰åœè»Šç©ºé–“åŠè·¯æ¬Šã€‚</li>`;
        if (hasNoElevatorHighFloor) routeHtml += `<li class="text-orange-600 font-bold">âš ï¸ é«˜æ¨“å±¤ç„¡é›»æ¢¯ï¼šè«‹ç¢ºèªæ¨“æ¢¯é–“æ·¨ç©ºã€‚</li>`;
        if (hasAlley) routeHtml += `<li class="text-red-600 font-bold">ğŸ›‘ å··å¼„ç¢ºèªï¼šè«‹ç¢ºèª3.5å™¸è²¨è»Šèƒ½å¦é§›å…¥ã€‚</li>`;
        if (hasTransfer) routeHtml += `<li class="text-blue-600">ğŸ’¡ é›»æ¢¯è½‰ä¹˜ï¼šè«‹äº‹å…ˆé ç´„è²¨æ¢¯ã€‚</li>`;
        if (!hasAlley) routeHtml += `<li class="text-green-700 font-medium">âœ… è«‹å”åŠ©é ç•™è²¨è»Šåœé ä½ç½®ã€‚</li>`;

        if (routeHtml) {
            html += `<div class="bg-gray-50 border-l-4 border-gray-500 p-3 rounded-r"><h4 class="font-bold text-gray-700 mb-1 flex items-center"><i class="fas fa-truck mr-2"></i>å‹•ç·šèˆ‡åœé ç¢ºèª</h4><ul class="text-sm space-y-1 pl-4 list-disc text-gray-600">${routeHtml}</ul></div>`;
        }

        let hasPackingService = (parseInt(req.services.preMovePacking) > 0 || parseInt(req.services.postMoveUnpacking) > 0);
        let hasDisassembly = (Object.values(res.disassemblyItemCounts).reduce((a,b)=>a+b,0) > 0);

        let serviceHtml = '';
        if (hasDisassembly) serviceHtml += `<li class="text-orange-600 font-bold">âš ï¸ æ‹†è£å‚¢ä¿±ï¼šè«‹æ¸…ç©ºè¡£æ«ƒã€åºŠçµ„å…§ç‰©å“ã€‚</li>`;
        if (hasPackingService) serviceHtml += `<li class="text-blue-600">ğŸ’¡ ä»£å®¢æ‰“åŒ…ï¼šè²´é‡ç‰©å“è«‹éš¨èº«æ”œå¸¶ã€‚</li>`;
        
        if (serviceHtml) {
            html += `<div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded-r"><h4 class="font-bold text-yellow-700 mb-1 flex items-center"><i class="fas fa-tools mr-2"></i>æ‹†è£èˆ‡æœå‹™æé†’</h4><ul class="text-sm space-y-1 pl-4 list-disc">${serviceHtml}</ul></div>`;
        }

        if (!hasPackingService) {
            html += `<div class="bg-green-50 border-l-4 border-green-500 p-3 rounded-r"><h4 class="font-bold text-green-700 mb-1 flex items-center"><i class="fas fa-box mr-2"></i>è‡ªè¡Œæ‰“åŒ…å°æ’‡æ­¥</h4><ul class="text-sm text-green-800 space-y-1 pl-4 list-disc"><li>æ›¸ç±è«‹ç”¨å°ç®±ï¼Œè¡£ç‰©å¯ç”¨å¤§ç®±ã€‚</li><li>æ˜“ç¢å“è«‹ç›´ç«‹æ“ºæ”¾ä¸¦å¡æ»¿ç·©è¡ã€‚</li></ul></div>`;
        }

        html += '</div>';
        container.innerHTML = html;
    }

// ==========================================
    // [ä¿®æ­£ç‰ˆ] æŒ‡å—ç”Ÿæˆå‡½å¼ (ä¿®å¾© basic undefined éŒ¯èª¤)
    // ==========================================
    async function generateGuide() {
        const loadingEl = document.getElementById('guide-loading');
        const contentEl = document.getElementById('guide-content');
        
        loadingEl.classList.remove('hidden');
        contentEl.innerHTML = ''; 

        // 1. [å®‰å…¨æ°£å›Š] ç¢ºä¿åŸºæœ¬è³‡æ–™å­˜åœ¨
        // å¦‚æœä½¿ç”¨è€…é‡æ–°æ•´ç†éç¶²é ï¼ŒuserData.basic å¯èƒ½æœƒè®Šç©ºï¼Œé€™è£¡å¼·åˆ¶è£œæ•‘
        if (!userData.basic || !userData.basic.name) {
             const saved = localStorage.getItem('ayue_user_info');
             if (saved) {
                 userData.basic = JSON.parse(saved);
                 console.log("å·²å¾ç·©å­˜æ¢å¾©åŸºæœ¬è³‡æ–™");
             } else {
                 // çœŸçš„æ²’æœ‰è³‡æ–™ï¼Œåªå¥½ç”¨å‡è³‡æ–™é ‚æ›¿ï¼Œé¿å…å ±éŒ¯å¡æ­»
                 userData.basic = { name: "è²´è³“", date: "è¿‘æœŸ", email: "", type: "home" };
             }
        }

        // 2. æ”¶é›† Step 3 (å€åŸŸå®¶å…·) è³‡æ–™
        const areasData = Array.from(document.querySelectorAll('.area-card')).map(card => {
            return {
                 name: card.querySelector('.area-name-input').value,
                 floorOut: card.querySelector('.area-out-floor-select').value,
                 floorIn: card.querySelector('.area-in-floor-select').value,
                 items: Array.from(card.querySelectorAll('.item-card')).map(row => ({
                    name: row.querySelector('.inp-name').value,
                    qty: row.querySelector('.inp-qty').value,
                    type: row.querySelector('.inp-type').value,
                    difficulty: row.querySelector('.inp-difficulty').value, 
                    disassembly: row.querySelector('.inp-disassembly').value, 
                    risk: row.querySelector('.inp-risknote').value
                  }))
            };
        });

        // 3. æ”¶é›† Step 2 (æ‰“åŒ…å€åŸŸ) è³‡æ–™
        const packingData = Array.from(document.querySelectorAll('.packing-card')).map(card => {
            return {
                name: card.querySelector('.area-name-input').value || 'æ‰“åŒ…å€åŸŸ',
                items: Array.from(card.querySelectorAll('.item-card')).map(row => ({
                    name: row.querySelector('.item-name').innerText, 
                    qty: row.querySelector('.val-qty').value,
                    tags: row.querySelector('.item-tags-detail')?.innerText || '',
                    risk: row.querySelector('.item-risk-text')?.innerText || '',
                    sop: row.querySelector('.item-sop')?.innerText || ''
                }))
            };
        });

        // 4. æº–å‚™å®Œæ•´è«‹æ±‚è³‡æ–™
        const fullData = {
            basic: userData.basic, 
            locations: userData.locations || [], 
            packing: userData.packing || {},       
            packingDetails: packingData, 
            services: {
                preMovePacking: document.getElementById('service-pack')?.checked || false,
                postMoveUnpacking: document.getElementById('service-unpack')?.checked || false,
                packingBoxes: document.getElementById('material-box')?.value || 0,
                bubbleWrap: document.getElementById('material-bubble')?.value || 0
            },
            areas: areasData, 
            specialNotes: document.getElementById('final-special-notes')?.value || "", 
            // å¦‚æœæ²’æœ‰ä¼°åƒ¹çµæœï¼Œçµ¦å€‹é è¨­å€¼é¿å…å ±éŒ¯
            quoteResult: userData.quoteResult || { totalFee: 0 } 
        };

        try {
            // ğŸŸ¢ã€é—œéµä¿®æ­£ã€‘ï¼šé€™è£¡åŠ ä¸Š { fullData: ... } çš„åŒ…è£
            // é€™æ¨£å¾Œç«¯æ‰èƒ½é€é request.fullData è®€å–åˆ°è³‡æ–™
            const res = await callBackendAPI('generateMovingGuide', { fullData: fullData });
            
            loadingEl.classList.add('hidden');
            
            if (res.error) {
                contentEl.innerHTML = `<div class="text-center text-red-500 py-10">æŒ‡å—ç”Ÿæˆå¤±æ•—ï¼š${res.error}</div>`;
            } else {
                // æ¸…ç†å¯èƒ½æ®˜ç•™çš„ markdown ç¬¦è™Ÿ
                let cleanHtml = res.html.replace(/```html/g, '').replace(/```/g, '').trim();
                contentEl.innerHTML = cleanHtml;
                
                // æˆåŠŸå¾Œï¼Œåˆå§‹åŒ–ç°½åæ¿
                setTimeout(initSignaturePad, 500);

                // é€™è£¡è¨»è§£æ‰è‡ªå‹•å­˜æª”ï¼Œé¿å…åˆå ±éŒ¯
                // autoSaveProgress(6, { guideHtml: cleanHtml });
            }
        } catch (err) {
            console.error(err);
            loadingEl.classList.add('hidden');
            contentEl.innerHTML = `<div class="text-center text-red-500 py-10">é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
        }
    }

    // ==========================================
    // 4. è‡ªå‹•å„²å­˜é€²åº¦ (å…¨æ–‡å­—ç›´è§€ç‰ˆ)
    // ==========================================
    function autoSaveProgress(currentStepIndex, extraData = {}) {
        const basicInfo = JSON.parse(localStorage.getItem('ayue_user_info') || '{}');
        if (!basicInfo.email) return;

        // 1. æ ¼å¼åŒ–å„æ­¥é©Ÿæ–‡å­—
        const step1Text = formatStep1ToText();
        const step2Text = formatStep2ToText();
        const step3Text = formatStep3ToText();
        const step5Text = formatStep5ToText();
         
        // 2. [æ–°å¢] æ ¼å¼åŒ– Step 6 æŒ‡å—å…§å®¹
        let step6Text = "";
        if (extraData.guideHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = extraData.guideHtml;
            step6Text = formatDomToText(tempDiv);
        } else {
            step6Text = formatStep6ToText();
        }

        // 3. çµ„è£ Payload
        const payload = {
            email: basicInfo.email,
            name: basicInfo.name,
            type: basicInfo.type,
            moveDate: basicInfo.date,
            referrer: basicInfo.referrer,
            currentStep: "Step " + currentStepIndex,
            step1: step1Text,
            step2: step2Text,
            step3: step3Text,
            notes: document.getElementById('final-special-notes')?.value || "",
            totalPrice: step5Text, 
            guideContent: step6Text, 
            isSent: extraData.isSent || "å¦"
        };

        // 4. å‚³é€ (ä¸ç­‰å¾…å›æ‡‰ï¼Œfire-and-forget)
        callBackendAPI('logUserProgress', payload).catch(err => console.log("AutoSave Failed:", err));
    }

    // ----------------------------------------------------
    // [æ–°å¢] å°‡ Step 6 æŒ‡å— HTML è½‰ç‚ºæ¼‚äº®ç´”æ–‡å­—
    // ----------------------------------------------------
    function formatStep6ToText() {
        const container = document.getElementById('guide-content');
        if (!container || container.innerHTML.trim() === '') return ""; 

        return formatDomToText(container);
    }

    // é€šç”¨ DOM è½‰æ–‡å­—æ’ç‰ˆå·¥å…·
    function formatDomToText(container) {
        const clone = container.cloneNode(true);

        clone.querySelectorAll('h1, h2, h3, h4, .timeline-title, .phase-title').forEach(el => {
            el.textContent = `\nã€${el.textContent.trim()}ã€‘\n`;
        });

        clone.querySelectorAll('.task-title').forEach(el => {
            el.textContent = `  â–  ${el.textContent.trim()}`;
        });

        clone.querySelectorAll('.task-5w2h-box, .timeline-content').forEach(el => {
            el.innerHTML = el.innerHTML.replace(/<br\s*\/?>/gi, '\n      '); 
            el.textContent = `      > ${el.textContent.trim()}\n`;
        });

        clone.querySelectorAll('li').forEach(el => {
            el.textContent = `   â€¢ ${el.textContent.trim()}\n`;
        });

        clone.querySelectorAll('p').forEach(el => {
            el.textContent = `${el.textContent.trim()}\n`;
        });

        let text = clone.innerText;
        text = text.replace(/\n\s*\n\s*\n/g, '\n\n');
         
        return text.trim();
    }

    function formatStep1ToText() {
        if (!userData.locations || userData.locations.length === 0) return "(å°šæœªè¨­å®šåœ°é»)";
        
        return userData.locations.map((l, idx) => {
            const typeStr = l.type === 'out' ? "ã€æ¬å‡º FROMã€‘" : "ã€æ¬å…¥ TOã€‘";
            const elevStr = l.hasElevator ? "æœ‰é›»æ¢¯" : `ç„¡é›»æ¢¯ (${l.floor})`;
            
            let analysis = "";
            if (l.pushUnits > 0 || l.stairsCount > 0 || l.craneHours > 0 || l.transferCount > 0) {
                analysis = `   âš ï¸ å‹•ç·šåˆ†æ: `;
                if(l.pushUnits > 0) analysis += `ä¸­åº­æ¨é‹ ${l.pushUnits}å€æ®µ, `;
                if(l.stairsCount > 0) analysis += `éšæ¢¯ ${l.stairsCount}è™•, `;
                if(l.transferCount > 0) analysis += `é›»æ¢¯è½‰ä¹˜ ${l.transferCount}æ¬¡, `;
                if(l.craneHours > 0) analysis += `åŠè»Š ${l.craneHours}å°æ™‚`;
            }
            if(analysis.endsWith(', ')) analysis = analysis.slice(0, -2);

            return `${typeStr} ${l.city}${l.area}\n   åœ°å€: ${l.addr}\n   æ¨“å±¤: ${elevStr}\n${analysis}`;
        }).join('\n\n');
    }

    function formatStep2ToText() {
        let report = "";
        const isPack = document.getElementById('service-pack')?.checked ? "â˜‘ æ˜¯" : "â˜ å¦";
        const isUnpack = document.getElementById('service-unpack')?.checked ? "â˜‘ æ˜¯" : "â˜ å¦";
        const boxCount = document.getElementById('material-box')?.value || 0;
        const bubbleCount = document.getElementById('material-bubble')?.value || 0;

        report += `ã€åŠ å€¼æœå‹™èˆ‡åŒ…æã€‘\n----------------\nä»£å®¢æ‰“åŒ…: ${isPack}\nä¸Šæ¶æ­¸ä½: ${isUnpack}\nè³¼è²·åŒ…æ: ç´™ç®± ${boxCount} å€‹, æ°£æ³¡å¸ƒ ${bubbleCount} æ²\n\n`;

        const packingCards = document.querySelectorAll('.packing-card');
        if (packingCards.length === 0) return report + "(å°šæœªæ–°å¢æ‰“åŒ…å€åŸŸ)";

        packingCards.forEach((card, idx) => {
            const name = card.querySelector('.area-name-input').value || `å€åŸŸ ${idx+1}`;
            const items = card.querySelectorAll('.item-card');
            
            const outSel = card.querySelector('.move-out-select');
            const inSel = card.querySelector('.move-in-select');
            const outFloor = card.querySelector('.move-out-floor-select');
            const inFloor = card.querySelector('.move-in-floor-select');
            
            const getTxt = (s) => s && s.selectedIndex >=0 ? s.options[s.selectedIndex].text : '';
            const outLoc = getTxt(outSel).replace('é¸æ“‡åœ°é»', '?');
            const inLoc = getTxt(inSel).replace('é¸æ“‡åœ°é»', '?');
            const outFl = outFloor.value ? `(${outFloor.value})` : '';
            const inFl = inFloor.value ? `(${inFloor.value})` : '';

            report += `ã€å€åŸŸ ${idx+1}: ${name}ã€‘\nå‹•ç·š: ${outLoc}${outFl} âœ ${inLoc}${inFl}\næ¸…å–®:\n`;

            if (items.length === 0) {
                report += `  (ç„¡ç‰©å“)\n`;
            } else {
                items.forEach((item, i) => {
                    const itemName = item.querySelector('.item-name')?.innerText || "";
                    const qty = item.querySelector('.val-qty')?.value || 1;
                    const tags = item.querySelector('.item-tags-detail')?.innerText || "";
                    const tools = item.querySelector('.item-materials')?.innerText || "ç„¡";
                    let sop = item.querySelector('.item-sop')?.innerText || "ç„¡";
                    sop = sop.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();

                    report += `  ${i+1}. ${itemName} (x${qty})\n     â€¢ æ¨™ç±¤: ${tags}\n     â€¢ å·¥å…·: ${tools}\n     â€¢ SOP: ${sop}\n`; 
                });
            }
            report += `\n`;
        });
        return report;
    }

    function formatStep3ToText() {
        const areaCards = document.querySelectorAll('.area-card');
        if (areaCards.length === 0) return "(å°šæœªæ–°å¢å‚¢ä¿±å€åŸŸ)";

        let report = "";
        areaCards.forEach((card, idx) => {
            const name = card.querySelector('.area-name-input').value || `å€åŸŸ ${idx+1}`;
            const items = card.querySelectorAll('.item-card');

            const outSel = card.querySelector('.area-move-out-select');
            const inSel = card.querySelector('.area-move-in-select');
            const outFloor = card.querySelector('.area-out-floor-select');
            const inFloor = card.querySelector('.area-in-floor-select');
            
            const getTxt = (s) => s && s.selectedIndex >=0 ? s.options[s.selectedIndex].text : '';
            const outLoc = getTxt(outSel).replace('é¸æ“‡åœ°é»', '?');
            const inLoc = getTxt(inSel).replace('é¸æ“‡åœ°é»', '?');
            const outFl = outFloor.value ? `(${outFloor.value})` : '';
            const inFl = inFloor.value ? `(${inFloor.value})` : '';

            report += `ã€å€åŸŸ ${idx+1}: ${name}ã€‘\nå‹•ç·š: ${outLoc}${outFl} âœ ${inLoc}${inFl}\n`;
            
            if (items.length === 0) {
                report += `  (ç„¡ç‰©å“)\n`;
            } else {
                items.forEach((item, i) => {
                    const itemName = item.querySelector('.item-name')?.innerText || "";
                    const qty = item.querySelector('.inp-qty')?.value || 1;
                    const diff = item.querySelector('.inp-difficulty')?.value || "";
                    const dis = item.querySelector('.inp-disassembly')?.value || "";
                    const risk = item.querySelector('.inp-risknote')?.value || "ç„¡";

                    report += `  ${i+1}. ${itemName} (x${qty})\n     è¦æ ¼: ${diff} | æ‹†è£: ${dis}\n`;
                    if(risk && risk !== 'ç„¡') report += `     âš ï¸ é¢¨éšª: ${risk}\n`;
                });
            }
            report += `\n`;
        });
        return report;
    }

    function formatStep5ToText() {
        const totalFeeEl = document.getElementById('result-total-fee');
        if (!totalFeeEl || totalFeeEl.innerText.trim() === "$ 0") return "";

        const total = totalFeeEl.innerText;
        let details = "";
        const rows = document.querySelectorAll('.breakdown-row');
        if (rows.length > 0) {
            details = Array.from(rows).map(row => {
                const label = row.querySelector('.breakdown-label')?.innerText || "";
                const desc = row.querySelector('.breakdown-desc')?.innerText || "";
                const val = row.querySelector('.breakdown-val')?.innerText || "$0";
                return `${label} ${desc} : ${val}`;
            }).join('\n');
        }
        return `ã€ç¸½åƒ¹ã€‘${total}\n----------------\n${details}`;
    }

    // ==========================================
    // 5. ç°½åèˆ‡å…¶ä»–
    // ==========================================
    function initSignaturePad() {
        const canvas = document.getElementById('signature-canvas');
        if(!canvas) return;
        
        signaturePad.canvas = canvas;
        signaturePad.ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        signaturePad.ctx.lineWidth = 2;
        signaturePad.ctx.lineCap = 'round';
        signaturePad.ctx.strokeStyle = '#000';

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousedown', { clientX: t.clientX, clientY: t.clientY })); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: t.clientX, clientY: t.clientY })); }, {passive: false});
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); canvas.dispatchEvent(new MouseEvent('mouseup', {})); });
    }

    function startDrawing(e) { signaturePad.isDrawing = true; const pos = getPos(e); signaturePad.ctx.beginPath(); signaturePad.ctx.moveTo(pos.x, pos.y); document.querySelector('.signature-placeholder').style.display = 'none'; }
    function draw(e) { if (!signaturePad.isDrawing) return; const pos = getPos(e); signaturePad.ctx.lineTo(pos.x, pos.y); signaturePad.ctx.stroke(); }
    function stopDrawing() { signaturePad.isDrawing = false; signaturePad.ctx.beginPath(); }
    function getPos(e) { const rect = signaturePad.canvas.getBoundingClientRect(); return { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
    function clearSignature() { if(!signaturePad.canvas) return; signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height); document.querySelector('.signature-placeholder').style.display = 'block'; }

    // ==========================================
    // 6. æˆªåœ–ç”Ÿæˆ PDF (æ™ºæ…§å †ç–Šç‰ˆ)
    // ==========================================
    function generateCustomFilename() {
        const info = JSON.parse(localStorage.getItem('ayue_user_info') || '{}');
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        const currentDate = `${yyyy}${mm}${dd}`;
        const currentTime = `${hh}${min}${ss}`;
        const name = info.name || 'unknown';
        const email = info.email || 'unknown';
        const referrer = info.referrer || 'none';
        const type = info.type || 'unknown';
        let moveDate = '00000000';
        if (info.date) moveDate = info.date.replace(/-/g, '');
        return `${currentDate}_${currentTime}_${name}_${email}_${referrer}_${type}_${moveDate}.pdf`;
    }

    async function handleEmailSend(btn) {
        if (!confirm('ç¢ºå®šè¦ç”Ÿæˆ PDF æŒ‡å—ä¸¦å¯„é€åˆ°æ‚¨çš„ Email å—ï¼Ÿ\n(éç¨‹ç´„éœ€ 10-20 ç§’ï¼Œè«‹å‹¿é—œé–‰è¦–çª—)')) return;

        setBtnLoading(btn, true);

        try {
            document.body.classList.add('printing-mode');
            
            document.querySelectorAll('.card-body, .item-body, .step-section').forEach(el => {
                el.style.display = 'block';
                el.classList.remove('hidden');
            });
            document.querySelectorAll('.card-collapsed-info').forEach(el => el.style.display = 'none');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const pdfHeight = pdf.internal.pageSize.getHeight(); 
            const margin = 10; 
            const contentWidth = pdfWidth - (margin * 2);
            
            let currentY = margin;

            const elementsToCapture = document.querySelectorAll(`
                header,
                #step-0, 
                .location-card,
                .packing-card,
                .area-card,
                .result-total-card,
                #step-5 .card,
                #step-6 > div.text-center, 
                #guide-content > div,      
                .terms-box,
                .signature-area
            `);

            for (let i = 0; i < elementsToCapture.length; i++) {
                const el = elementsToCapture[i];
                if (el.offsetParent === null || el.innerText.trim() === '') continue;

                const canvas = await html2canvas(el, {
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    width: 800, 
                    windowWidth: 800
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * contentWidth) / imgProps.width;

                if (currentY + imgHeight > pdfHeight - margin) {
                    pdf.addPage();
                    currentY = margin; 
                }

                pdf.addImage(imgData, 'JPEG', margin, currentY, contentWidth, imgHeight);
                currentY += imgHeight + 3; 
            }

            const filename = generateCustomFilename();
            const pdfBase64 = pdf.output('datauristring').split(',')[1];

            const payload = {
                base64: pdfBase64,
                filename: filename,
                email: JSON.parse(localStorage.getItem('ayue_user_info') || '{}').email,
                name: JSON.parse(localStorage.getItem('ayue_user_info') || '{}').name
            };

            // API å‘¼å«ï¼šå¯„é€ PDF
            const res = await callBackendAPI('processClientPdfAndEmail', payload);

            setBtnLoading(btn, false);
            document.body.classList.remove('printing-mode'); 
            if (res.error) {
                alert('å¯„é€å¤±æ•—ï¼š' + res.error);
            } else {
                alert(`ğŸ‰ å®Œç¾ PDF æŒ‡å—å·²å¯„å‡ºï¼\næª”åï¼š${filename}`);
                autoSaveProgress(6, { isSent: "æ˜¯ (PDF)" });
            }

        } catch (err) {
            console.error(err);
            setBtnLoading(btn, false);
            document.body.classList.remove('printing-mode');
            alert('ç”Ÿæˆ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æˆªåœ–çµ¦å·¥ç¨‹å¸«ï¼š' + err.message);
        }
    }

    // Helper Functions
    function selectType(val, el) { if(!el) return; document.querySelectorAll('.option-card').forEach(c => { c.classList.remove('selected'); c.querySelector('i').classList.remove('text-brand-yellow'); c.querySelector('i').classList.add('text-gray-300'); }); el.classList.add('selected'); el.querySelector('i').classList.remove('text-gray-300'); el.querySelector('i').classList.add('text-brand-yellow'); document.getElementById('input-type').value = val; }
    function getDiffDays(dateStr) { const today=new Date(); today.setHours(0,0,0,0); return Math.ceil((new Date(dateStr)-today)/(864e5)); }
    function checkDate() { const d = document.getElementById('input-date').value; if(!d) return; const days = getDiffDays(d); const box = document.getElementById('date-alert'); box.className = 'hidden mt-3 p-3 rounded-xl text-sm border bg-gray-50 text-gray-600 font-medium'; if(days<3) { box.classList.remove('hidden'); box.innerText="ğŸš¨ æ€¥ä»¶ï¼ç´…è‰²è­¦æˆ’ SOP å•Ÿå‹•"; } else if(days<7) { box.classList.remove('hidden'); box.innerText="âš¡ï¸ æœ‰é»è¶•ï¼Œå»ºè­°ç›¡å¿«æ‰“åŒ…"; } }
    function getStep0Data() { return { name: document.getElementById('input-name').value, date: document.getElementById('input-date').value, type: document.getElementById('input-type').value, email: document.getElementById('input-email').value }; }
    function loadFromStorage() { const saved = localStorage.getItem('ayue_user_info'); if (saved) { const d = JSON.parse(saved); if(d.name) document.getElementById('input-name').value=d.name; if(d.email) document.getElementById('input-email').value=d.email; if(d.date) { document.getElementById('input-date').value=d.date; checkDate(); } if(d.type) { const el=document.querySelector(`.option-card[onclick*='${d.type}']`); if(el) selectType(d.type, el); } } }
    function addLocation(type) { if(locCounts[type]>=5) return alert('æœ€å¤š5å€‹'); locCounts[type]++; const tpl = document.getElementById('tpl-location-card'); const clone = tpl.content.cloneNode(true); const card = clone.querySelector('.card'); card.dataset.type = type; card.dataset.id = `${type}-${Date.now()}`; card.querySelector('.badge-type').innerText = (type==='out'?'æ¬å‡º':'æ¬å…¥')+' '+locCounts[type]; card.querySelector('.badge-type').classList.add(type==='out'?'bg-brand-teal':'bg-brand-yellow'); const citySel = card.querySelector('.city-select'); Object.keys(TAIWAN_DATA).forEach(c => citySel.add(new Option(c,c))); citySel.onchange = e => { const dSel = card.querySelector('.dist-select'); dSel.innerHTML='<option>å€åŸŸ</option>'; (TAIWAN_DATA[e.target.value]||[]).forEach(d => dSel.add(new Option(d,d))); }; document.getElementById(`${type}-list`).appendChild(card); cardImages[card.dataset.id] = []; }
    function removeLocation(btn) { btn.closest('.card').remove(); }
    function setElevator(btn, has) { const c = btn.closest('.card'); c.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); c.dataset.hasElev = has; if(has) { c.querySelector('.floor-yes').classList.remove('hidden'); c.querySelector('.floor-no').classList.add('hidden'); } else { c.querySelector('.floor-yes').classList.add('hidden'); c.querySelector('.floor-no').classList.remove('hidden'); } }
    function toggleFloor(btn, val) { btn.classList.toggle('selected'); const p = btn.parentElement; const selected = Array.from(p.querySelectorAll('.selected')).map(b => b.innerText); p.parentElement.querySelector('.floor-btn-val').value = selected.join(','); }
    function setBtnLoading(btn, isLoading) { if (isLoading) { btn.classList.add('btn-loading'); btn.dataset.originalText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; } else { btn.classList.remove('btn-loading'); if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText; } }
    function handleMultiPhoto(input, cat, max) { if(!input.files.length) return; const card = input.closest('.card'); const cid = card.dataset.id; const container = card.querySelector(`#container-${cat}`); if (container.querySelectorAll('.photo-thumbnail').length + input.files.length > max) return alert(`æ­¤å€å¡Šæœ€å¤š ${max} å¼µ`); if(!cardImages[cid]) cardImages[cid]=[]; Array.from(input.files).forEach(f => { cardImages[cid].push({ file: f, category: cat }); const reader = new FileReader(); reader.onload = e => { const div = document.createElement('div'); div.className = 'photo-thumbnail group relative flex-shrink-0 w-20 h-20 rounded-xl overflow-hidden border border-gray-200'; div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover"><div class="photo-delete absolute top-1 right-1 bg-black/60 text-white rounded-full w-5 h-5 flex items-center justify-center cursor-pointer" onclick="removePhoto(this, '${cid}', '${f.name}')">Ã—</div>`; container.insertBefore(div, input.parentElement); }; reader.readAsDataURL(f); }); input.value = ''; }
    function removePhoto(btn, cid, fileName) { btn.parentElement.remove(); if (cardImages[cid]) { const idx = cardImages[cid].findIndex(f => f.file.name === fileName); if (idx > -1) cardImages[cid].splice(idx, 1); } }
    
    // AI å‹•ç·šåˆ†æ (ä¿®æ”¹ç‰ˆ)
    function runAiAnalysis(btn) { 
        const card = btn.closest('.card'); 
        const cid = card.dataset.id; 
        const imgs = cardImages[cid]||[]; 
        if(imgs.length===0) return alert('è«‹å…ˆæ‹æ”å‹•ç·šç…§ç‰‡'); 
        setBtnLoading(btn, true); 
        const ps = imgs.map(i => new Promise(r => { const rd = new FileReader(); rd.onload=e=>r({base64:e.target.result.split(',')[1], mimeType:i.file.type}); rd.readAsDataURL(i.file); })); 
        
        Promise.all(ps).then(async (pl) => { 
            try {
                // API å‘¼å«ï¼šå‹•ç·šåˆ†æ
                const res = await callBackendAPI('analyzeAccessImages', { images: pl });
                
                setBtnLoading(btn, false); 
                btn.innerHTML = '<i class="fas fa-magic"></i> é‡æ–°è¾¨è­˜'; 
                if(res.error) return alert('AIå¤±æ•—'); 
                const box = card.querySelector('.ai-result-box'); 
                box.classList.remove('hidden'); 
                setTimeout(()=>box.classList.remove('opacity-0','translate-y-4'),10); 
                box.scrollIntoView({behavior:'smooth'}); 
                card.querySelector('.dist-input').value = res.long_push_units||0; 
                card.querySelector('.stairs-input').value = res.stairs_count||0; 
                card.querySelector('.transfer-input').value = res.transfer_count||0; 
                card.querySelector('.risk-note').value = res.risk_note||''; 
                if(res.recommend_crane) { 
                    card.querySelector('.crane-input').value=2; 
                    card.querySelector('.crane-alert').classList.remove('hidden'); 
                    card.querySelector('.crane-reason').innerText=res.crane_reason; 
                } else { 
                    card.querySelector('.crane-input').value=0; 
                    card.querySelector('.crane-alert').classList.add('hidden'); 
                } 
            } catch (err) {
                setBtnLoading(btn, false);
            }
        }); 
    }

    function getStep1Data() { return Array.from(document.querySelectorAll('.location-card')).map(c => ({ id: c.dataset.id, type: c.dataset.type, city: c.querySelector('.city-select')?.value || '', area: c.querySelector('.dist-select')?.value || '', addr: c.querySelector('.addr-input')?.value || '', floor: c.dataset.hasElev!=='false' ? (c.querySelector('.floor-input-val')?.value || '') : (c.querySelector('.floor-btn-val')?.value || ''), hasElevator: c.dataset.hasElev!=='false', distance: c.querySelector('.dist-input')?.value || 0, pushUnits: c.querySelector('.dist-input')?.value || 0, craneHours: c.querySelector('.crane-input')?.value || 0, transferCount: c.querySelector('.transfer-input')?.value || 0, riskNote: c.querySelector('.risk-note')?.value || '' })); }
    function updateLocationOptions(step1Data) { if(!step1Data) return; locationOptions.out = step1Data.filter(l => l.type === 'out').map((l, idx) => { const nameStr = `${idx+1}. ${l.city}${l.area}`; return { id: l.id, name: nameStr, floors: l.floor.split(',') }; }); locationOptions.in = step1Data.filter(l => l.type === 'in').map((l, idx) => { const nameStr = `${idx+1}. ${l.city}${l.area}`; return { id: l.id, name: nameStr, floors: l.floor.split(',') }; }); document.querySelectorAll('.packing-card').forEach(card => { populateLocationSelects(card); updateFloorSelect(card.querySelector('.move-out-select'), 'out'); updateFloorSelect(card.querySelector('.move-in-select'), 'in'); updateCollapsedInfo(card.querySelector('.move-out-select')); }); }
    function populateLocationSelects(card) { const outSel = card.querySelector('.move-out-select') || card.querySelector('.area-move-out-select'); const inSel = card.querySelector('.move-in-select') || card.querySelector('.area-move-in-select'); if(!outSel || !inSel) return; const v1 = outSel.value; const v2 = inSel.value; outSel.innerHTML = '<option value="">é¸æ“‡åœ°é»</option>'; inSel.innerHTML = '<option value="">é¸æ“‡åœ°é»</option>'; locationOptions.out.forEach(o => outSel.add(new Option(o.name, o.id))); locationOptions.in.forEach(o => inSel.add(new Option(o.name, o.id))); outSel.value = v1; inSel.value = v2; }
    function updateFloorSelect(sel, type) { if(!sel) return; const locId = sel.value; const card = sel.closest('.dynamic-card'); let selectorClass = ''; if (type === 'out') { selectorClass = card.classList.contains('area-card') ? '.area-out-floor-select' : '.move-out-floor-select'; } else { selectorClass = card.classList.contains('area-card') ? '.area-in-floor-select' : '.move-in-floor-select'; } const targetEl = card.querySelector(selectorClass); if(targetEl) { const oldVal = targetEl.value; targetEl.innerHTML = '<option value="">é¸æ“‡æ¨“å±¤</option>'; const list = type === 'out' ? locationOptions.out : locationOptions.in; const loc = list.find(l => l.id === locId); if (loc && loc.floors) { loc.floors.forEach(f => { if(f.trim()) targetEl.add(new Option(f.trim(), f.trim())); }); } if(oldVal && targetEl.querySelector(`option[value="${oldVal}"]`)) targetEl.value = oldVal; else if(targetEl.options.length > 1) targetEl.selectedIndex = 1; } }
    function updateCollapsedInfo(el) { const card = el.closest('.dynamic-card'); if (!card || !card.classList.contains('packing-card')) return; const totalQty = Array.from(card.querySelectorAll('.val-qty')).reduce((sum, el) => sum + (parseInt(el.value)||0), 0); card.querySelector('.card-summary').innerText = ` * ${totalQty}`; const outSel = card.querySelector('.move-out-select'); const inSel = card.querySelector('.move-in-select'); const outFloor = card.querySelector('.move-out-floor-select'); const inFloor = card.querySelector('.move-in-floor-select'); const getTxt = (sel) => sel.options[sel.selectedIndex]?.text || '?'; const cleanTxt = (t) => t === 'é¸æ“‡åœ°é»' || t === 'é¸æ“‡æ¨“å±¤' ? '?' : t.split('.')[1] || t; const getFl = (sel) => sel.value ? `(${sel.value})` : ''; const outStr = cleanTxt(getTxt(outSel)) + getFl(outFloor); const inStr = cleanTxt(getTxt(inSel)) + getFl(inFloor); const infoEl = card.querySelector('.info-text'); if(outSel.value || inSel.value) { infoEl.innerHTML = `<span class="text-brand-teal font-bold">${outStr}</span> <i class="fas fa-long-arrow-alt-right mx-1 text-gray-300"></i> <span class="text-brand-yellow font-bold">${inStr}</span>`; } else { infoEl.innerText = 'å°šæœªè¨­å®šè·¯ç·š (é»æ“Šå±•é–‹è¨­å®š)'; } }
    function toggleCard(header) { const card = header.closest('.dynamic-card'); const body = card.querySelector('.card-body'); const info = card.querySelector('.card-collapsed-info'); const icon = header.querySelector('.toggle-icon'); if (body.classList.contains('hidden')) { body.classList.remove('hidden'); info.classList.add('hidden'); icon.style.transform = 'translateY(-50%) rotate(90deg)'; } else { body.classList.add('hidden'); info.classList.remove('hidden'); icon.style.transform = 'translateY(-50%) rotate(0deg)'; if(card.classList.contains('packing-card')) updateCollapsedInfo(header); if(card.classList.contains('area-card')) updateAreaSummaryText(header); } }
    function removeCard(e, btn) { e.stopPropagation(); btn.closest('.dynamic-card').remove(); calcStep2Total(); }
    function updateCardTitle(input) { input.closest('.dynamic-card').querySelector('.card-title').innerText = input.value || 'æ–°å€åŸŸ'; }
    function copyCard(e, btn) { e.stopPropagation(); const originalCard = btn.closest('.dynamic-card'); const newCard = originalCard.cloneNode(true); const newId = `area-${Date.now()}`; newCard.dataset.id = newId; if(originalCard.classList.contains('packing-card')) { newCard.id = newId; newCard.querySelector('.area-name-input').value += " (è¤‡è£½)"; newCard.querySelector('.photo-scroll-container').id = `container-${newId}`; newCard.querySelector('.photo-scroll-container').innerHTML = `<label class="add-photo-btn group"><input type="file" class="hidden" accept="image/*" multiple onchange="handlePackingPhoto(this)"><i class="fas fa-camera text-xl mb-1 group-hover:text-brand-teal transition"></i><span class="text-[10px] text-gray-400">æ–°å¢</span></label>`; newCard.querySelector('.item-list').innerHTML = ''; document.getElementById('packing-area-list').appendChild(newCard); } else { areaFilesStore.set(newId, []); newCard.querySelector('.area-photo-container').innerHTML = `<label class="add-photo-btn group"><input type="file" class="hidden" accept="image/*" multiple onchange="handleAreaPhoto(this)"><i class="fas fa-camera text-xl mb-1 group-hover:text-brand-primary transition"></i><span class="text-[10px] text-gray-400">æ–°å¢</span></label>`; newCard.querySelector('.item-list').innerHTML = ''; const aiBtn = newCard.querySelector('.btn-ai-action'); aiBtn.innerHTML = '<i class="fas fa-magic mr-1"></i> <span>é–‹å§‹è¾¨è­˜æ¬é‹ç‰©</span>'; setBtnLoading(aiBtn, false); originalCard.after(newCard); } const selects = originalCard.querySelectorAll('select'); const newSelects = newCard.querySelectorAll('select'); selects.forEach((sel, i) => newSelects[i].value = sel.value); updateCardTitle(newCard.querySelector('.area-name-input')); }
    function addPackingArea() { const tpl = document.getElementById('tpl-packing-area'); const clone = tpl.content.cloneNode(true); const card = clone.querySelector('.dynamic-card'); const id = `pack-area-${Date.now()}`; card.dataset.id = id; cardImages[id] = []; card.querySelector('.photo-scroll-container').id = `container-${id}`; card.querySelector('input[type="file"]').setAttribute('onchange', `handlePackingPhoto(this, '${id}')`); populateLocationSelects(card); document.getElementById('packing-area-list').appendChild(card); }
    function handlePackingPhoto(input, cid) { if(!input.files.length) return; const container = input.parentElement.parentElement; Array.from(input.files).forEach(file => { cardImages[cid].push({ file: file, category: 'packing' }); const reader = new FileReader(); reader.onload = e => { const div = document.createElement('div'); div.className = 'photo-thumbnail flex-shrink-0 w-20 h-20 rounded-xl relative overflow-hidden border border-gray-200'; div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover"><div class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full flex items-center justify-center cursor-pointer text-xs" onclick="removePhoto(this, '${cid}', '${file.name}')">Ã—</div>`; container.insertBefore(div, input.parentElement); }; reader.readAsDataURL(file); }); input.value = ''; }
    
    // AI æ‰“åŒ…åˆ†æ (ä¿®æ”¹ç‰ˆ)
    function runPackingAnalysis(btn) { 
        const card = btn.closest('.dynamic-card'); 
        const cid = card.dataset.id; 
        const imgs = cardImages[cid]||[]; 
        if (imgs.length === 0) return alert('è«‹å…ˆæ‹æ”æ«ƒå…§æˆ–é›œç‰©ç…§ç‰‡'); 
        setBtnLoading(btn, true); 
        const ps = imgs.map(i => new Promise(r => { const rd = new FileReader(); rd.onload=e=>r({base64:e.target.result.split(',')[1], mimeType:i.file.type}); rd.readAsDataURL(i.file); })); 
        
        Promise.all(ps).then(async (pl) => { 
            try {
                // API å‘¼å«ï¼šæ‰“åŒ…åˆ†æ
                const res = await callBackendAPI('analyzePackingImages', { images: pl });
                
                setBtnLoading(btn, false); 
                if (res.error) { console.error("AI Error:", res); return alert('AI åˆ†æå¤±æ•—ï¼š' + res.error); } 
                btn.innerHTML = '<i class="fas fa-check"></i> åˆ†æå®Œæˆ'; 
                const list = card.querySelector('.item-list'); 
                list.innerHTML = ''; 
                list.classList.remove('hidden'); 
                let itemsToRender = []; 
                if (res.items && Array.isArray(res.items)) itemsToRender = res.items; else if (Array.isArray(res)) itemsToRender = res; 
                if (itemsToRender.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 py-4 text-xs">AI æ²’æœ‰è¾¨è­˜å‡ºå…·é«”ç‰©å“ï¼Œè«‹è©¦è‘—é è¿‘ä¸€é»æ‹æ”ã€‚</div>'; return; } 
                const itemTpl = document.getElementById('tpl-packing-item'); 
                itemsToRender.forEach(item => { const clone = itemTpl.content.cloneNode(true); clone.querySelector('.item-name').innerText = item.name || 'æœªå‘½åç‰©å“'; clone.querySelector('.item-qty').innerText = item.qty || 1; clone.querySelector('.val-qty').value = item.qty || 1; if (item.tags) clone.querySelector('.item-tags-detail').innerText = item.tags; else { const tagEl = clone.querySelector('.item-tags-detail'); if(tagEl && tagEl.parentElement) tagEl.parentElement.classList.add('hidden'); } if (item.sop) { const sopContainer = clone.querySelector('.item-sop'); let sopRaw = item.sop || ''; if (sopRaw.match(/\d+\./)) { const steps = sopRaw.split(/(?=\d+\.)/g); let tableHtml = '<table class="w-full text-xs border-collapse">'; let hasContent = false; steps.forEach(step => { step = step.trim(); if (!step) return; const parts = step.match(/^(\d+\.[^ï¼š:]+)[ï¼š:]([\s\S]*)/); if (parts && parts.length >= 3) { hasContent = true; const title = parts[1].trim(); const content = parts[2].trim(); tableHtml += ` <tr class="border-b border-gray-100 last:border-0 hover:bg-gray-50"> <td class="py-2 pr-2 font-bold text-brand-teal whitespace-nowrap align-top w-[80px]">${title}</td> <td class="py-2 text-gray-600 align-top leading-relaxed text-justify">${content}</td> </tr>`; } else { if(step.length > 2) { tableHtml += ` <tr class="border-b border-gray-100 last:border-0"> <td colspan="2" class="py-2 text-gray-600 align-top leading-relaxed">${step}</td> </tr>`; } } }); tableHtml += '</table>'; sopContainer.innerHTML = hasContent ? tableHtml : sopRaw.split('\n').join('<br>'); } else { sopContainer.innerHTML = sopRaw.split('\n').join('<br>'); } } if (item.materials) clone.querySelector('.item-materials').innerText = item.materials || ''; if (item.risk) { clone.querySelector('.item-risk-text').innerText = item.risk; clone.querySelector('.item-risk').classList.remove('hidden'); } if(item.summary) { clone.querySelector('.item-summary-text').innerText = item.summary; clone.querySelector('.item-summary').classList.remove('hidden'); } list.appendChild(clone); }); calcStep2Total(); updateCollapsedInfo(card); 
            } catch (err) {
                setBtnLoading(btn, false);
            }
        }); 
    }

    function toggleItem(header) { const card = header.closest('.item-card'); const body = card.querySelector('.item-body'); const icon = header.querySelector('.toggle-icon-item'); if (body.classList.contains('active')) { body.classList.remove('active'); body.style.display = 'none'; icon.classList.remove('rotate-90'); } else { body.style.display = 'block'; setTimeout(() => { body.classList.add('active'); }, 10); icon.classList.add('rotate-90'); } }
    function removeItem(e, btn) { const card = btn.closest('.dynamic-card'); e.stopPropagation(); btn.closest('.item-card').remove(); calcStep2Total(); updateCollapsedInfo(card); }
    function calcStep2Total() { let totalBoxes = 0; document.querySelectorAll('.val-qty').forEach(el => { totalBoxes += parseInt(el.value || 0); }); const boxCount = parseInt(document.getElementById('material-box').value) || 0; const bubbleCount = parseInt(document.getElementById('material-bubble').value) || 0; let fee = 0; if (document.getElementById('service-pack').checked) fee += totalBoxes * 500; if (document.getElementById('service-unpack').checked) fee += totalBoxes * 600; fee += boxCount * 50; fee += bubbleCount * 500; document.getElementById('step2-total').innerText = `$ ${fee.toLocaleString()}`; userData.packing = { totalBoxes, fee }; }
    function updateStep3Dropdowns() { document.querySelectorAll('.area-card').forEach(card => { populateLocationSelects(card); }); }
    function addAreaCard() { const tpl = document.getElementById('tpl-area-card'); const clone = tpl.content.cloneNode(true); const card = clone.querySelector('.area-card'); const id = `area-${Date.now()}`; card.dataset.id = id; areaFilesStore.set(id, []); populateLocationSelects(card); document.getElementById('area-list-container').appendChild(card); updateCardTitle(card.querySelector('.area-name-input')); }
    function removeAreaCard(e, btn) { e.stopPropagation(); const card = btn.closest('.area-card'); areaFilesStore.delete(card.dataset.id); card.remove(); const undoBtn = document.getElementById('undo-area-btn'); undoBtn.disabled = false; undoBtn.onclick = () => { addAreaCard(); undoBtn.disabled = true; }; }
    function undoDeleteArea() { addAreaCard(); document.getElementById('undo-area-btn').disabled = true; }
    function updateAreaRoute(select) { const type = select.classList.contains('area-move-out-select') ? 'out' : 'in'; updateFloorSelect(select, type); updateAreaSummaryText(select); }
    function updateAreaSummaryText(el) { const card = el.closest('.area-card'); const outSel = card.querySelector('.area-move-out-select'); const inSel = card.querySelector('.area-move-in-select'); const outFloor = card.querySelector('.area-out-floor-select'); const inFloor = card.querySelector('.area-in-floor-select'); const getTxt = (sel) => sel.options[sel.selectedIndex]?.text || '?'; const cleanTxt = (t) => t === 'é¸æ“‡åœ°é»' || t === 'é¸æ“‡æ¨“å±¤' ? '?' : t.split('.')[1] || t; const getFl = (sel) => sel.value ? `(${sel.value})` : ''; const outT = cleanTxt(getTxt(outSel)) + getFl(outFloor); const inT = cleanTxt(getTxt(inSel)) + getFl(inFloor); const infoEl = card.querySelector('.info-text'); if(outSel.value || inSel.value) { infoEl.innerHTML = `${outT} <i class="fas fa-long-arrow-alt-right mx-2 text-gray-300"></i> ${inT}`; } else { infoEl.innerText = 'å°šæœªè¨­å®šè·¯ç·š'; } }
    function handleAreaPhoto(input) { if (!input.files.length) return; const card = input.closest('.area-card'); const areaId = card.dataset.id; const container = card.querySelector('.area-photo-container'); const currentFiles = areaFilesStore.get(areaId) || []; Array.from(input.files).forEach(file => { if (currentFiles.some(f => f.file.name === file.name && f.file.size === file.size)) return; const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`; currentFiles.push({ id: fileId, file: file, processed: false }); const thumb = document.createElement('div'); thumb.className = 'photo-thumbnail flex-shrink-0 w-20 h-20 rounded-xl relative overflow-hidden border border-gray-200'; thumb.dataset.fileId = fileId; const reader = new FileReader(); reader.onload = e => { thumb.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover"><div class="btn-delete-img" onclick="deleteAreaPhoto('${areaId}', '${fileId}', this)">Ã—</div>`; container.insertBefore(thumb, container.lastElementChild); }; reader.readAsDataURL(file); }); areaFilesStore.set(areaId, currentFiles); input.value = ''; }
    function deleteAreaPhoto(areaId, fileId, btn) { let files = areaFilesStore.get(areaId); files = files.filter(f => f.id !== fileId); areaFilesStore.set(areaId, files); btn.closest('.photo-thumbnail').remove(); }
    
    // AI å€åŸŸå‚¢ä¿±è¾¨è­˜ (ä¿®æ”¹ç‰ˆ)
    async function runAreaRecognition(btn) { 
        const card = btn.closest('.area-card'); 
        const areaId = card.dataset.id; 
        const files = (areaFilesStore.get(areaId) || []).filter(f => !f.processed); 
        if (!files.length) return alert('æ²’æœ‰æ–°çš„ç…§ç‰‡éœ€è¦è¾¨è­˜'); 
        setBtnLoading(btn, true); 
        const areaName = card.querySelector('.area-name-input').value; 
        const floorText = card.querySelector('.area-out-floor-select').value; 
        const listContainer = card.querySelector('.item-list'); 
        listContainer.classList.remove('hidden'); 
        
        for (const f of files) { 
            try { 
                const base64 = await new Promise((res) => { const r = new FileReader(); r.onload = () => res(r.result.split(',')[1]); r.readAsDataURL(f.file); }); 
                // API å‘¼å«ï¼šå€åŸŸè¾¨è­˜
                const resultText = await callBackendAPI('callGeminiApi', { base64: base64, type: f.file.type, areaName: areaName, floor: floorText });
                
                parseAndRenderAiResult(resultText, listContainer); 
                f.processed = true; 
                const thumb = card.querySelector(`.photo-thumbnail[data-file-id="${f.id}"]`); 
                if(thumb) thumb.style.opacity = '0.5'; 
            } catch (err) { 
                console.error('AI Error:', err); 
            } 
        } 
        setBtnLoading(btn, false); 
        btn.innerHTML = '<i class="fas fa-check"></i> è¾¨è­˜å®Œæˆ'; 
    }

    function parseAndRenderAiResult(text, container) { if (!text || text.startsWith('éŒ¯èª¤')) return; const lines = text.trim().split('\n').filter(l => l.trim() !== ''); const tpl = document.getElementById('tpl-ai-item-row'); for (let i = 0; i < lines.length; i++) { const line = lines[i].trim(); if (line.startsWith('å€åŸŸï¼š') || line.startsWith('ã€')) continue; const nextLine = lines[i+1] ? lines[i+1].trim() : ''; if (nextLine.startsWith('ã€')) { const match = line.match(/(.+) * (\d+)/); const name = match ? match[1].trim() : line; const qty = match ? match[2].trim() : '1'; const attrs = nextLine.match(/ã€.*?ã€‘/g)?.map(s => s.replace(/[ã€ã€‘]/g, '')) || []; let type='', mat='', diff='', dis=''; const KNOWN_DIFFS = ["ä¸€äººå¯æ¬", "äºŒäººå¯æ¬", "ä¸€äººæŠ€è¡“æ¬", "äºŒäººæŠ€è¡“æ¬", "ç‰¹æ®ŠæŠ€æ³•æ¬"]; const KNOWN_DIS = ["ç„¡éœ€æ‹†è£", "ç°¡æ˜“æ‹†è£", "è¤‡é›œæ‹†è£", "ç³»çµ±æ‹†è£", "ç‰¹æŠ€æ‹†è£"]; attrs.forEach(a => { if(KNOWN_DIFFS.includes(a)) diff = a; else if(KNOWN_DIS.includes(a)) dis = a; else if(["è£ç®±æ‰“åŒ…ç‰©", "å¤§å‹å‚¢ä¿±", "å¤§å‹å®¶é›»", "ä¸­å‹å‚¢ä¿±", "ä¸­å‹å®¶é›»", "å°å‹å‚¢ä¿±"].includes(a)) type = a; else mat += a + ' '; }); if(!type && attrs.length>0) type = attrs[0]; let riskText = '', skipLines = 1; if (lines[i+2] && lines[i+2].trim().includes('é¢¨éšªæç¤º')) { riskText = lines[i+2].replace(/ã€.*?ã€‘/g, '').replace(/^[ï¼š:]/, '').trim(); skipLines = 2; } const clone = tpl.content.cloneNode(true); const row = clone.querySelector('.item-card'); row.querySelector('.inp-name').value = name; row.querySelector('.inp-qty').value = qty; row.querySelector('.inp-type').value = type; row.querySelector('.inp-material').value = mat; row.querySelector('.inp-difficulty').value = diff || 'ä¸€äººå¯æ¬'; row.querySelector('.inp-disassembly').value = dis || 'ç„¡éœ€æ‹†è£'; row.querySelector('.inp-risknote').value = riskText; updateAiItemDisplay(row.querySelector('.inp-name')); container.appendChild(row); i += skipLines; } } }
    function updateAiItemDisplay(input) { const card = input.closest('.item-card'); const name = card.querySelector('.inp-name').value; const qty = card.querySelector('.inp-qty').value; const type = card.querySelector('.inp-type').value; const mat = card.querySelector('.inp-material').value; const diff = card.querySelector('.inp-difficulty').value; const dis = card.querySelector('.inp-disassembly').value; const risk = card.querySelector('.inp-risknote').value; card.querySelector('.item-name').innerText = name; card.querySelector('.item-qty').innerText = `${qty}`; const tagContainer = card.querySelector('.item-tags-row'); let html = ''; if(type) html += `<span class="tag-std">${type}</span>`; if(mat) html += `<span class="tag-std">${mat}</span>`; let diffClass = 'tag-std'; if (diff.includes('æŠ€è¡“') || diff.includes('ç‰¹æ®Š')) diffClass = 'tag-highlight'; html += `<span class="${diffClass}">${diff}</span>`; if(dis) html += `<span class="tag-std">${dis}</span>`; tagContainer.innerHTML = html; const riskBar = card.querySelector('.item-risk-bar'); if(risk && risk !== 'ç„¡' && risk.trim() !== '') { riskBar.innerText = risk; riskBar.classList.remove('hidden'); riskBar.classList.remove('risk-bg-red', 'risk-bg-orange', 'risk-bg-green'); if (diff.includes('ç‰¹æ®Š') || diff.includes('æŠ€è¡“')) riskBar.classList.add('risk-bg-red'); else if (diff.includes('äºŒäºº')) riskBar.classList.add('risk-bg-orange'); else riskBar.classList.add('risk-bg-green'); } else { riskBar.classList.add('hidden'); } }
    function toggleAiItem(header) { const body = header.nextElementSibling; const icon = header.querySelector('.item-arrow-icon'); if(body.classList.contains('active')) { body.classList.remove('active'); icon.style.transform = 'rotate(0deg)'; } else { body.classList.add('active'); icon.style.transform = 'rotate(90deg)'; } }
    function deleteAiItem(e, btn) { e.stopPropagation(); if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç‰©å“ï¼Ÿ')) btn.closest('.item-card').remove(); }
    function copyAiItem(e, btn) { e.stopPropagation(); const card = btn.closest('.item-card'); const clone = card.cloneNode(true); clone.querySelectorAll('input, select, textarea').forEach(input => { const originalInput = card.querySelector(`.${Array.from(input.classList).find(c => c.startsWith('inp-'))}`); if(originalInput) input.value = originalInput.value; }); updateAiItemDisplay(clone.querySelector('.inp-name')); card.parentElement.insertBefore(clone, card.nextSibling); }

    // ==========================================
    // [NEW] é ç´„è™•ç†é‚è¼¯ (API æ•´åˆç‰ˆ)
    // ==========================================
    async function handleBooking() {
        const btn = document.getElementById('btn-book-now');
        if (!confirm('ç¢ºå®šè¦é€å‡ºé ç´„å—ï¼Ÿ\nç³»çµ±å°‡æœƒä¸Šå‚³æ‚¨çš„ç…§ç‰‡ä¸¦å¯„ç™¼ç¢ºèªä¿¡ä»¶ã€‚\n(æª”æ¡ˆè¼ƒå¤§æ™‚è«‹è€å¿ƒç­‰å€™ 10-30 ç§’)')) return;

        // 1. UI è®Šæ›´ç‚º Loading
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> è³‡æ–™ä¸Šå‚³ä¸­...';

        try {
            // 2. æº–å‚™åœ–ç‰‡è³‡æ–™ (è½‰ Base64) - é€™éƒ¨åˆ†ç¶­æŒåŸæ¨£ï¼Œåªå‚³é€åŸå§‹ç…§ç‰‡
            const imagesData = await prepareAllImages();

            // 3. æº–å‚™æ–‡å­—è³‡æ–™ (åŸºæœ¬è³‡è¨Š)
            const guideContent = document.getElementById('guide-content').innerHTML;
            const totalFee = document.getElementById('result-total-fee').innerText;
            const notes = document.getElementById('final-special-notes').value;

            // (A) æŠ“å– [Step 2 æ‰“åŒ…å€åŸŸ] çš„è©³ç´°è³‡æ–™
            const packingDetailsData = Array.from(document.querySelectorAll('.packing-card')).map(card => {
                 const outSel = card.querySelector('.move-out-select');
                 const inSel = card.querySelector('.move-in-select');
                 const getTxt = (s) => s && s.selectedIndex >= 0 ? s.options[s.selectedIndex].text : '';
                 return {
                    name: card.querySelector('.area-name-input').value || 'æ‰“åŒ…å€åŸŸ',
                    moveOutSelect: getTxt(outSel), 
                    moveInSelect: getTxt(inSel),   
                    items: Array.from(card.querySelectorAll('.item-card')).map(row => ({
                        name: row.querySelector('.item-name').innerText, 
                        qty: row.querySelector('.val-qty').value,
                        tags: row.querySelector('.item-tags-detail')?.innerText || '', 
                        risk: row.querySelector('.item-risk-text')?.innerText || '',   
                        sop: row.querySelector('.item-sop')?.innerText || ''           
                    }))
                };
            });

            // (B) æŠ“å– [Step 3 æ¬é‹å€åŸŸ] çš„æ‘˜è¦è³‡æ–™
            const areasData = Array.from(document.querySelectorAll('.area-card')).map(card => {
                return {
                     name: card.querySelector('.area-name-input').value || 'æœªå‘½åå€åŸŸ',
                     floorOut: card.querySelector('.area-out-floor-select').value,
                     floorIn: card.querySelector('.area-in-floor-select').value,
                     items: [] // é€™è£¡æ•…æ„ç•™ç©º
                };
            });

            // 4. çµ„åˆæœ€çµ‚ Payload (å‚³é€çµ¦å¾Œç«¯çš„åŒ…è£¹)
            const payload = {
                basic: userData.basic,           
                locations: userData.locations,   
                packingDetails: packingDetailsData, 
                areas: areasData,                
                specialNotes: notes,             
                totalFee: totalFee,              
                guideHtml: guideContent,         
                images: imagesData               
            };

            // 5. å‚³é€è‡³å¾Œç«¯ (API å‘¼å«)
            const res = await callBackendAPI('processBooking', payload);

            if (res.success) {
                // æˆåŠŸç‹€æ…‹
                btn.innerHTML = '<i class="fas fa-check"></i> é ç´„æˆåŠŸ';
                btn.classList.remove('bg-brand-dark');
                btn.classList.add('bg-green-600');
                
                alert('ğŸ‰ é ç´„è³‡æ–™å·²æˆåŠŸé€å‡ºï¼\nç¢ºèªä¿¡å·²å¯„è‡³æ‚¨çš„ä¿¡ç®±ã€‚\nè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥å®˜æ–¹ LINE é€²è¡Œå¾ŒçºŒç¢ºèªã€‚');
                
                // éš±è—æ“ä½œæŒ‰éˆ•ï¼Œé¡¯ç¤º LINE æŒ‰éˆ•
                document.getElementById('action-buttons').style.display = 'none';
                document.getElementById('btn-line-connect').classList.remove('hidden');
                
                // ç´€éŒ„é€²åº¦ (å·²å®Œæˆé ç´„)
                autoSaveProgress(6, { isSent: "æ˜¯ (å·²é ç´„)" });
            } else {
                throw new Error(res.error);
            }

        } catch (err) {
            console.error(err);
            alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–è¯ç¹«å®¢æœï¼š' + err.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // [è¼”åŠ©] å°‡æ‰€æœ‰åœ–ç‰‡è½‰ç‚º Base64 ä¸¦åˆ†é¡
    async function prepareAllImages() {
        const result = {
            route: [],   // å°æ‡‰ 1_å‹•ç·šç…§ç‰‡
            packing: [], // å°æ‡‰ 2_æ•´ç†æ‰“åŒ…ç…§ç‰‡
            item: []     // å°æ‡‰ 3_æ¬é‹ç‰©ä»¶ç…§ç‰‡
        };

        // 1. è™•ç† Step 1 (å‹•ç·š) & Step 2 (æ‰“åŒ…) çš„åœ–ç‰‡
        for (const cardId in cardImages) {
            const images = cardImages[cardId];
            for (const imgObj of images) {
                const base64 = await fileToBase64(imgObj.file);
                const payload = { 
                    name: imgObj.file.name, 
                    type: imgObj.file.type, 
                    base64: base64 
                };

                // åˆ†é¡é‚è¼¯
                if (['indoor', 'path', 'park'].includes(imgObj.category)) {
                    result.route.push(payload);
                } else if (imgObj.category === 'packing') {
                    result.packing.push(payload);
                }
            }
        }

        // 2. è™•ç† Step 3 (æ¬é‹ç‰©ä»¶) çš„åœ–ç‰‡
        for (const [areaId, files] of areaFilesStore.entries()) {
            for (const fileObj of files) {
                const base64 = await fileToBase64(fileObj.file);
                result.item.push({
                    name: fileObj.file.name,
                    type: fileObj.file.type,
                    base64: base64
                });
            }
        }

        return result;
    }

    // [è¼”åŠ©] å–®ä¸€æª”æ¡ˆè½‰ Base64 Promise
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const result = reader.result;
                const base64 = result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }



</script>
</html>
